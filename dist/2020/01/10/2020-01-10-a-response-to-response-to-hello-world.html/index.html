<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.0.3"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://shybovycha.github.io/2020/01/10/2020-01-10-a-response-to-response-to-hello-world.html/"><!-- Primary Meta Tags --><title>A response to response to hello world</title><meta name="title" content="A response to response to hello world"><meta name="description"><link rel="stylesheet" href="/_astro/index.BvFNhZYw.css">
<style>footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
[data-astro-image]{width:100%;height:auto;object-fit:var(--fit);object-position:var(--pos);aspect-ratio:var(--w) / var(--h)}[data-astro-image=responsive]{max-width:calc(var(--w) * 1px);max-height:calc(var(--h) * 1px)}[data-astro-image=fixed]{width:calc(var(--w) * 1px);height:calc(var(--h) * 1px)}
</style></head> <body data-astro-cid-bvzihdzo> <nav class="top"> <div class="links"> <a class="nav-link nav-item" href="/">Home</a> <a class="nav-link nav-item" href="/about.html">About</a> </div> </nav> <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="hero-image" data-astro-cid-bvzihdzo>  </div> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2020-01-10T04:10:24.000Z"> Jan 10, 2020 </time>  </div> <h1 data-astro-cid-bvzihdzo>A response to response to hello world</h1> <hr data-astro-cid-bvzihdzo> </div>  <p>Recently I’ve received an email from StackOverflow newsletters with a link to a quite controversial (at first glance) blog, <a href="https://www.doxsey.net/blog/a-response-to-hello-world">A response to Hello World</a> by Caleb Doxsey. This blog is a response to another curious read, <a href="https://drewdevault.com/2020/01/04/Slow.html">Hello world</a> by Drew DeVault.</p>
<p>In the former article, author compared the performance of a tiny “Hello, World” program in Assembly to the same program in Go.
He then tried to optimize the program in Go to run faster and towards the end of an article comes up with a program that is faster than its Assembly counterpart.</p>
<img alt="" data-src="/images/a-response-to-response-to-hello-world/hello-world-original-chart-min.webp">
<img alt="" data-src="/images/a-response-to-response-to-hello-world/hello-world-new-chart-min.webp">
<img alt="" data-src="/images/a-response-to-response-to-hello-world/hello-world-new-chart2-min.webp">
<p>And this totally makes sense, since if you give it a good read, you will notice that author did optimize the program in Go but did not do that for the Assembly program.</p>
<p>I have decided to burn few hours of my life and jump onto this topic, since, in my opinion, author did not do a fair comparison.</p>
<!--more-->
<p>The original code Caleb has used is (I have added the imports and package declaration required to run the program):</p>
<h3 id="go">Go</h3>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">package</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "</span><span style="color:#6F42C1;--shiki-dark:#B392F0">strconv</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "</span><span style="color:#6F42C1;--shiki-dark:#B392F0">os</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">func</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    n, _ </span><span style="color:#D73A49;--shiki-dark:#F97583">:=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> strconv.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Atoi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(os.Args[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    for</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> i </span><span style="color:#D73A49;--shiki-dark:#F97583">:=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; i </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> n; i</span><span style="color:#D73A49;--shiki-dark:#F97583">++</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        os.Stdout.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Write</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([]</span><span style="color:#D73A49;--shiki-dark:#F97583">byte</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"hello world</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\n</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">))</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="assembly">Assembly</h3>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="asm"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">_start:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsp</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> + </span><span style="color:#005CC5;--shiki-dark:#79B8FF">16</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> atoi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">helloloop:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, len</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, msg</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    syscall</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    dec</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    cmp</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jg</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .helloloop</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">60</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    syscall</span></span>
<span class="line"></span></code></pre>
<h3 id="optimized-go">Optimized Go</h3>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">package</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "</span><span style="color:#6F42C1;--shiki-dark:#B392F0">strconv</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "</span><span style="color:#6F42C1;--shiki-dark:#B392F0">os</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "</span><span style="color:#6F42C1;--shiki-dark:#B392F0">bufio</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">func</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    n, _ </span><span style="color:#D73A49;--shiki-dark:#F97583">:=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> strconv.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Atoi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(os.Args[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">])</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    w </span><span style="color:#D73A49;--shiki-dark:#F97583">:=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> bufio.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">NewWriter</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(os.Stdout)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    defer</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> w.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Flush</span><span style="color:#24292E;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    for</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> i </span><span style="color:#D73A49;--shiki-dark:#F97583">:=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; i </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> n; i</span><span style="color:#D73A49;--shiki-dark:#F97583">++</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        w.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Write</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([]</span><span style="color:#D73A49;--shiki-dark:#F97583">byte</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"hello world"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">))</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>What Caleb did was string concatenation in memory, creating a big string in memory and then calling the system function to print it out only once.
Indeed this is way more performant than making an IO syscall every iteration.</p>
<p>Since Caleb did not provide an equal program in Assembly, I decided to fill this gap.
I have spent quite some time (predominantly because I am quite rusty with Assembly at the moment and I forgot that different OSes use <a href="https://en.wikipedia.org/wiki/X86_calling_conventions">different calling conventions</a>).
I came up with the code in Assembly that does exactly the same - allocates the memory, fills it with the repeated <code>"hello world"</code> string and then makes a syscall to print it to the console.</p>
<h3 id="my-optimized-assembly">My optimized Assembly</h3>
<div class="content-read-marker" data-fraction="25"></div>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="asm"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; compile me on OSX: nasm -fmacho64 helloworld.asm &#x26;&#x26; ld helloworld.o -lSystem -macosx_version_min 10.13</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; compile me on Linux: nasm -felf64 helloworld.asm &#x26;&#x26; ld helloworld.o # AND DO NOT FORGET TO ALIGN WITH THE SYSCALL CONVENTION BY USING STACK INSTEAD OF REGISTERS</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">global</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">extern</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _malloc, _puts, _atoi, _free</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">section .text</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">_main:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">load_counter:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    cmp</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jne</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .exit_failure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r13</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> + </span><span style="color:#005CC5;--shiki-dark:#79B8FF">8</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _atoi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r13</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">calculate_memory_length:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, len</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    imul</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    inc</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">allocate_memory:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _malloc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    test</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jz</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .exit_failure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">repeat_message:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">repeat_message_1:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    lea</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#D73A49;--shiki-dark:#F97583">rel</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> msg]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, len</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    cld</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">copy_message:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">], </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    inc</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    inc</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    dec</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jnz</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .copy_message</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">repeat_message_2:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    dec</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jnz</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .repeat_message_1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">], </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">print_string_builder:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _puts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">free_memory:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _free</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exit_success:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jmp</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .exit</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exit_failure:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exit:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0x02000001</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    syscall</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">section .data</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">msg:</span><span style="color:#D73A49;--shiki-dark:#F97583"> db</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> "Hello, world", </span><span style="color:#005CC5;--shiki-dark:#79B8FF">10</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">len </span><span style="color:#005CC5;--shiki-dark:#79B8FF">equ</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> $ - msg</span></span>
<span class="line"></span></code></pre>
<div class="content-read-marker" data-fraction="50"></div>
<h3 id="my-version-with-logs">My version with logs</h3>
<p>As Caleb highlights in his blog, a lot of “burden” introduced by many languages (referring to the original blog by Drew DeVault) is the debugging and safety related information.</p>
<p>I went ahead and added few logs, memory deallocation and test for allocation success to the code in Assembly:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="asm"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; compile me on OSX: nasm -fmacho64 helloworld.asm &#x26;&#x26; ld helloworld.o -lSystem -macosx_version_min 10.13</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; compile me on Linux: nasm -felf64 helloworld.asm &#x26;&#x26; ld helloworld.o # AND DO NOT FORGET TO ALIGN WITH THE SYSCALL CONVENTION BY USING STACK INSTEAD OF REGISTERS</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">global</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _main </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; a function declaration - an entry point; use `_start` for Linux</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">extern</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _malloc, _puts, _atoi, _printf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">section .text</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">_main:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">load_counter:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r13</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    cmp</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; check ARGC - program takes exactly ONE argument, so checking if ARGC == 2 (first one being program name)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jne</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .exit_failure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; log</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; store ARGC in R12</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r13</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> + </span><span style="color:#005CC5;--shiki-dark:#79B8FF">8</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; store the ARGV[2] (by addressing it with *(ARGV + 1)) in R13</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; preserve all the used registers on stack - required by OSX calling convention</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, log1 </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; copy format string to RDI</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; copy first argument for _printf to RSI</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; copy second argument for _printf to RDX</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; zero out RAX to enable variable function arguments</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _printf </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; syscall to printf()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdx</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; restore the registers' values</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; end log</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    ; mov r12, rsi ;; pointer to argv (which is a pointer on its own)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; move the address of argv[1] (r12 + 0 => argv[0], r12 + 8 => argv[1]) to rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _atoi </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; convert char* argv[1] to int and store the result in rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r13</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; store counter as int in r13</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; log</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, log2</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _printf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; end log</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">calculate_memory_length:</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    ;; rdi = counter * len</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, len</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    imul</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    inc</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; +1 for the terminal character (\0)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; store total length in r12</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">allocate_memory:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; number of bytes to allocate</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _malloc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    test</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; test the return code of _malloc syscall</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jz</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .exit_failure </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; if it is an error - go to exit(1)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; store address in r12</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">repeat_message:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; set outer loop counter to COUNTER</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; set destination address to the stored address from malloc call</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">repeat_message_1:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; push outer loop counter onto stack - we don't need it just yet, but will need it after the inner loop is done</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    lea</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#D73A49;--shiki-dark:#F97583">rel</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> msg] </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; load address of our message to repeat into the source address</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, len </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; set inner loop counter to the length of a message</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    cld</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; reset the string copying direction flag</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">copy_message:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; load the next byte from the source memory</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">], </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; copy the loaded byte to the destination memory</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    inc</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; advance source pointer</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    inc</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; advamce destimation pointer</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    dec</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; decrease the inner loop counter</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jnz</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .copy_message</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">repeat_message_2:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; restore the outer loop counter</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    dec</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; decrement the outer loop counter</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jnz</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .repeat_message_1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">], </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; put \0 at current RDI</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">print_string_builder:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; set first argument to the allocated memory start</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _puts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exit_success:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; exit argument - exit status - 0</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jmp</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .exit</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exit_failure:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exit:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0x02000001</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; syscall id - exit; use `60` for Linux</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    syscall</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">section .data</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">msg:</span><span style="color:#D73A49;--shiki-dark:#F97583"> db</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> "Hello, world", </span><span style="color:#005CC5;--shiki-dark:#79B8FF">10</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">len </span><span style="color:#005CC5;--shiki-dark:#79B8FF">equ</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> $ - msg</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">log1:</span><span style="color:#D73A49;--shiki-dark:#F97583"> db</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> "argc = %d, argv[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] = %s", </span><span style="color:#005CC5;--shiki-dark:#79B8FF">10</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">log2:</span><span style="color:#D73A49;--shiki-dark:#F97583"> db</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> "atoi = %d", </span><span style="color:#005CC5;--shiki-dark:#79B8FF">10</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span></span>
<span class="line"></span></code></pre>
<h2 id="comparison">Comparison</h2>
<p>Finally, I ran the aforementioned programs with the following arguments: <code>1M</code>, <code>2.5M</code>, <code>5M</code>, <code>7.5M</code>, <code>10M</code>, <code>12.5M</code>, <code>15M</code> and <code>17.5M</code> (where <code>M</code> stands for “million”).</p>
<p>The results became more reasonable:</p>
<img alt="" data-src="/images/a-response-to-response-to-hello-world/go_vs_asm_hello_world-min.webp">
<div class="content-read-marker" data-fraction="100"></div>  </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2024 Your name here. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://m.webtoo.ls/@astro" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on Mastodon</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/mastodon" data-astro-cid-sz7xmlte><path fill="currentColor" d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://twitter.com/astrodotbuild" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/withastro/astro" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Astro's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> </div> </footer>  </body></html>