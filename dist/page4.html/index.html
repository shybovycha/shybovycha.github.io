<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.0.3"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://shybovycha.github.io/page4.html/"><!-- Primary Meta Tags --><title>moofoo blog</title><meta name="title" content="moofoo blog"><meta name="description" content="Welcome to my website!"><link rel="stylesheet" href="/_astro/index.BvFNhZYw.css">
<style>[data-astro-image]{width:100%;height:auto;object-fit:var(--fit);object-position:var(--pos);aspect-ratio:var(--w) / var(--h)}[data-astro-image=responsive]{max-width:calc(var(--w) * 1px);max-height:calc(var(--h) * 1px)}[data-astro-image=fixed]{width:calc(var(--w) * 1px);height:calc(var(--h) * 1px)}
</style></head> <body> <nav class="top"> <div class="links"> <a class="nav-link nav-item" href="/">Home</a> <a class="nav-link nav-item" href="/about.html">About</a> </div> </nav> <main> <section> <article> <h1> <a href="/2021/04/19/2021-04-19-introduction.html">Strongly-typed front-end: introduction</a> </h1> <time datetime="2021-04-18T23:36:15.000Z"> Apr 19, 2021 </time> <div class="content"> <h3 id="contents">Contents</h3>
<ol>
<li><a href="/strongly-typed-front-end/2021/04/19/introduction.html"><strong>Introduction (you are here)</strong></a></li>
<li><a href="/strongly-typed-front-end/experiment-1/2021/04/19/experiment-1.html">Experiment 1, darken_color</a></li>
<li>Experiment 2, simple application
<ul>
<li><a href="/strongly-typed-front-end/experiment-2/2021/04/19/experiment-2-elm.html">Elm</a></li>
<li><a href="/strongly-typed-front-end/experiment-2/2021/04/19/experiment-2-fsharp.html">F#</a></li>
<li><a href="/strongly-typed-front-end/experiment-2/2021/04/19/experiment-2-purescript.html">PureScript &#x26; purescript-react-dom</a></li>
<li><a href="/strongly-typed-front-end/experiment-2/2024/05/17/experiment-2-purescript-halogen.html">PureScript &#x26; Halogen</a></li>
<li><a href="/strongly-typed-front-end/experiment-2/2021/04/19/experiment-2-reasonml.html">ReasonML</a></li>
</ul>
</li>
</ol>
<p>In this little research project I describe my journey through a series of experiments trying out a number of technologies and clashing them against each other.</p>
<p>I have always questioned the <em>real value</em> all those languages that compile to JS, especially TypeScript or Flow, give you.</p>
<p>So I have asked Atlassian front-enders a question:</p>
<blockquote>
<p>I need your opinions for my research: what benefits does TypeScript (or Flow, depending on your camp) give you? why do you use it?</p>
</blockquote>
<p>The answers I have received varied but the common themes were:</p>
<ul>
<li>we like types! üòç</li>
<li>less errors</li>
<li>easier refactoring</li>
<li>tools &#x26; IDEs integration (mainly for code navigation and autocomplete)</li>
<li>self-documented or more readable code</li>
</ul>
<p>The issues I see with TypeScript and Flow are bit closer to the real world:</p>
<ul>
<li>they catch way too few errors - unless your <strong>whole project</strong> (including 3rd party dependencies) is using the thing <strong>correctly</strong>, you will see the errors whenever you end up in the layer between native JS and typed code</li>
<li>more often than not, error messages are either pointless or hard to read (see the examples below)</li>
</ul>
<p>I do acknowledge the earlier you catch an error, the cheaper the fix would be. You have to put some effort into writing the typed code, but if it only catches a fraction of errors and only at compile time, then why all the hassle?</p>
<h2 id="benefits-of-typescript">‚ÄùBenefits‚Äù of TypeScript</h2>
<h3 id="pointless-errors">Pointless errors</h3>
<p>The most issues I have seen so far happen in what is considered an stdlib:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">interface</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> MyClass</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">  id</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">  val</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> a</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> MyClass</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  { id : </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'moo'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, val: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, </span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  { id: </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'foo'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, val: </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  { id: </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'bar'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, val: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">3.14</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> counts</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> a.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">reduce</span><span style="color:#24292E;--shiki-dark:#E1E4E8">((</span><span style="color:#E36209;--shiki-dark:#FFAB70">acc</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">e</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">has</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id)) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id, acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id) </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> e.val);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  } </span><span style="color:#D73A49;--shiki-dark:#F97583">else</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id, e.val);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> acc;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}, </span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Map</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#005CC5;--shiki-dark:#79B8FF">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>());</span></span>
<span class="line"></span></code></pre>
<p>Here we are reducing a list of objects. TS is freaking out every time you are using <code>Map</code> (however, it is a natively supported type, IIRC) - calling <code>map.get()</code> will always produce <code>T | undefined</code> type, unless you explicitly tell TS the type is <code>T</code> by using the <code>as</code> operator:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id, acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id) </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> e.val); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// ERROR: Object is possibly 'undefined'.</span></span>
<span class="line"></span></code></pre>
<p>Adding an explicit check does not have any effect:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">has</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id) </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id) </span><span style="color:#D73A49;--shiki-dark:#F97583">!==</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> undefined</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id, acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id) </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> e.val); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// TS does not give a damn: Object is possibly 'undefined'.</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>whereas</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id, acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id) </span><span style="color:#D73A49;--shiki-dark:#F97583">as</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> number</span><span style="color:#D73A49;--shiki-dark:#F97583"> +</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> e.val); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// OK</span></span>
<span class="line"></span></code></pre>
<p>But the issue is: if you do not add the check, the value in fact might be <code>undefined</code>.</p>
<p>Flow has flaws here too:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">/* @flow */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">interface</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> MyClass</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">  id</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">  val</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> a</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> MyClass</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  { id : </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'moo'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, val: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, </span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  { id: </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'foo'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, val: </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  { id: </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'bar'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, val: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">3.14</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> counts</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> a.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">reduce</span><span style="color:#24292E;--shiki-dark:#E1E4E8">((</span><span style="color:#E36209;--shiki-dark:#FFAB70">acc</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">e</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">has</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id) </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id) </span><span style="color:#D73A49;--shiki-dark:#F97583">!==</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> undefined</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) { </span><span style="color:#6A737D;--shiki-dark:#6A737D">// ERROR: Cannot perform arithmetic operation because undefined [1] is not a number. [unsafe-addition]</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id, acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id) </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> e.val);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  } </span><span style="color:#D73A49;--shiki-dark:#F97583">else</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id, e.val);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  </span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> acc;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}, </span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Map</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#005CC5;--shiki-dark:#79B8FF">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>());</span></span>
<span class="line"></span></code></pre>
<p>But it provides a bit more context about the issue:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>    16:     acc.set(e.id, acc.get(e.id) + e.val);</span></span>
<span class="line"><span>                          ^ Cannot perform arithmetic operation because undefined [1] is not a number. [unsafe-addition]</span></span>
<span class="line"><span>        References:</span></span>
<span class="line"><span>        [LIB] ..//static/v0.135.0/flowlib/core.js:617:     get(key: K): V | void;</span></span>
<span class="line"><span>                                                                            ^ [1]</span></span>
<span class="line"><span></span></span></code></pre>
<p>Both Flow and TS work fine if you extract the <code>.get</code> call result to a variable and add a check for <code>undefined</code>:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">interface</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> MyClass</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">    id</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">    val</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> a</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> MyClass</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    { id : </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'moo'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, val: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, </span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    { id: </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'foo'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, val: </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    { id: </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'bar'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, val: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">3.14</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> counts</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> a.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">reduce</span><span style="color:#24292E;--shiki-dark:#E1E4E8">((</span><span style="color:#E36209;--shiki-dark:#FFAB70">acc</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">e</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> prevVal</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (prevVal </span><span style="color:#D73A49;--shiki-dark:#F97583">!==</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> undefined</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id, prevVal </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> e.val);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    } </span><span style="color:#D73A49;--shiki-dark:#F97583">else</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        acc.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.id, e.val);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> acc;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}, </span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Map</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#005CC5;--shiki-dark:#79B8FF">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>());</span></span>
<span class="line"></span></code></pre>
<h3 id="implementation-specific-errors">Implementation-specific errors</h3>
<p>In order to <em>understand</em> this error message, you have to know how enums are implemented in TypeScript:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">enum</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Figure</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  RECTANGLE</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  SQUARE</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  CIRCLE</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> area</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Record</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Figure</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  [Figure.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">RECTANGLE</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]: (</span><span style="color:#E36209;--shiki-dark:#FFAB70">w</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">h</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> w </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> h,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  [Figure.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">CIRCLE</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]: (</span><span style="color:#E36209;--shiki-dark:#FFAB70">r</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Math.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">PI</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> r </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> r,</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // ERROR: Property '1' is missing in type '{ 0: (w: number, h: number) => number; 2: (r: number) => number; }' but required in type 'Record&#x3C;Figure, Function>'.</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">log</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(area);</span></span>
<span class="line"></span></code></pre>
<p>Enums in TS are backed by numbers, <em>by default</em>. In order for that error above to make sense, you have to provide some sort of a reasonable (<code>.toString()</code>-backed) value for enum values:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">enum</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Figure</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  RECTANGLE</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'RECTANGLE'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  SQUARE</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'SQUARE'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  CIRCLE</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'CIRCLE'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> area</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Record</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Figure</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  [Figure.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">RECTANGLE</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]: (</span><span style="color:#E36209;--shiki-dark:#FFAB70">w</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">h</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> w </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> h,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  [Figure.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">CIRCLE</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]: (</span><span style="color:#E36209;--shiki-dark:#FFAB70">r</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Math.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">PI</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> r </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> r,</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  // ERROR: Property 'SQUARE' is missing in type '{ RECTANGLE: (w: number, h: number) => number; CIRCLE: (r: number) => number; }' but required in type 'Record&#x3C;Figure, Function>'.</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">log</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(area);</span></span>
<span class="line"></span></code></pre>
<h3 id="runtime-is-imperfect">Runtime is imperfect</h3>
<p>You might have typed every single bit of your project and all the 3rd party dependencies. And you did it right. This still does not guarantee you won‚Äôt have <code>Can not read property XXX of undefined or XXX is not a function</code> at run time.</p>
<p>Type system won‚Äôt really save you, if you only have covered some of the use cases, but the user ended up in uncovered one:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> React, { useState, useCallback } </span><span style="color:#D73A49;--shiki-dark:#F97583">from</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'react'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">enum</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Shape</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  SQUARE</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'SQUARE'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  CIRCLE</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'CIRCLE'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> AREA</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Record</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Shape</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  [Shape.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">SQUARE</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]: (</span><span style="color:#E36209;--shiki-dark:#FFAB70">side</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> side </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> side,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  [Shape.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">CIRCLE</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]: (</span><span style="color:#E36209;--shiki-dark:#FFAB70">r</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Math.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">PI</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> r </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> r,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#D73A49;--shiki-dark:#F97583"> default</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> () </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">shape</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">setShape</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> useState</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Shape</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">null</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">value</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">setValue</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> useState</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#005CC5;--shiki-dark:#79B8FF">number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">area</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">setArea</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> useState</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#005CC5;--shiki-dark:#79B8FF">number</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> onShapeChanged</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> useCallback</span><span style="color:#24292E;--shiki-dark:#E1E4E8">((</span><span style="color:#E36209;--shiki-dark:#FFAB70">e</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> React</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">ChangeEvent</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">HTMLSelectElement</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    setShape</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.target.value);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  }, []);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> onValueChanged</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> useCallback</span><span style="color:#24292E;--shiki-dark:#E1E4E8">((</span><span style="color:#E36209;--shiki-dark:#FFAB70">e</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> React</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">ChangeEvent</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">HTMLInputElement</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    setValue</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">parseFloat</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.target.value));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  }, []);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> onSubmit</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> useCallback</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(() </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    setArea</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">AREA</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[shape](value));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  }, [shape, value]);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    &#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">div</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      &#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">select onChange</span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{onShapeChanged}</span><span style="color:#D73A49;--shiki-dark:#F97583">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        &#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">option value</span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF">""</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">Choose shape</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;/</span><span style="color:#24292E;--shiki-dark:#E1E4E8">option</span><span style="color:#D73A49;--shiki-dark:#F97583">></span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        {</span><span style="color:#E36209;--shiki-dark:#FFAB70">Object</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#E36209;--shiki-dark:#FFAB70">keys</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">AREA</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span><span style="color:#E36209;--shiki-dark:#FFAB70">map</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">shape</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">option</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> value</span><span style="color:#24292E;--shiki-dark:#E1E4E8">={</span><span style="color:#E36209;--shiki-dark:#FFAB70">shape</span><span style="color:#24292E;--shiki-dark:#E1E4E8">}>{shape}</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;/</span><span style="color:#24292E;--shiki-dark:#E1E4E8">option</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">))}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      &#x3C;/</span><span style="color:#24292E;--shiki-dark:#E1E4E8">select</span><span style="color:#D73A49;--shiki-dark:#F97583">></span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      &#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">input value</span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{value} onChange</span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{onValueChanged} </span><span style="color:#D73A49;--shiki-dark:#F97583">/></span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      &#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">button onClick</span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{onSubmit}</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">Calculate area</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;/</span><span style="color:#24292E;--shiki-dark:#E1E4E8">button</span><span style="color:#D73A49;--shiki-dark:#F97583">></span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      &#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">div</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#E36209;--shiki-dark:#FFAB70">        Area</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span><span style="color:#E36209;--shiki-dark:#FFAB70">area</span><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      &#x3C;/</span><span style="color:#24292E;--shiki-dark:#E1E4E8">div</span><span style="color:#D73A49;--shiki-dark:#F97583">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    &#x3C;/</span><span style="color:#24292E;--shiki-dark:#E1E4E8">div</span><span style="color:#D73A49;--shiki-dark:#F97583">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  );</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span></code></pre>
<p>This is a quite simple application (<a href="https://codesandbox.io/s/happy-sutherland-1qtwb">sandbox</a>), built on top of the previous example with enums and records in TypeScript.</p>
<p>There are at least two uncovered scenarios in this application, resulting in errors:</p>
<ol>
<li>when user does not select a shape and clicks ‚Äúcalculate‚Äù, the <code>TypeError: AREA[shape] is not a function</code> will be thrown</li>
<li>when user types anything but number in the input, the value immediately becomes <code>NaN</code>; if user then clicks ‚Äúcalculate‚Äù, an error won‚Äôt be thrown (since the app does not use the calculation result in any way), but the area calculated will also be <code>NaN</code>; for this example this is fine, but imagine using the value further down the line in some financial calculations</li>
</ol>
<p>This is a trivial synthetic example and the errors might be easy to spot and fix, but the important question is: <em>did TypeScript help you find those errors?</em></p>
<p>If you set up TSLint, you might have <em>some</em> errors caught:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Argument of type 'null' is not assignable to parameter of type 'Shape | (() => Shape)'.ts(2345)</span></span>
<span class="line"><span>Argument of type 'string' is not assignable to parameter of type 'SetStateAction&#x3C;Shape>'.ts(2345)</span></span>
<span class="line"><span>Type 'null' cannot be used as an index type.ts(2538)</span></span>
<span class="line"><span></span></span></code></pre>
<p>Unless you do the right thing, you <em>might</em> end up fixing those scenarios. But instead, I often see solutions like these (<a href="https://codesandbox.io/s/winter-river-dvzwd">sandbox</a>):</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">shape</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">setShape</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> useState</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Shape</span><span style="color:#D73A49;--shiki-dark:#F97583"> |</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">null</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">setShape</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(e.target.value </span><span style="color:#D73A49;--shiki-dark:#F97583">as</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Shape</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">setArea</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(shape </span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> AREA</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[shape](value) </span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span></code></pre>
<p>Those solutions do solve a subset of errors, at a cost of readability and potential other errors.</p>
<h3 id="there-are-no-classes-in-javascript">There are no classes in JavaScript</h3>
<p>Found this one recently, apparently TypeScript classes are same as JavaScript (ES6) classes:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">namespace</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> TypeScriptIsGarbage</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  export</span><span style="color:#D73A49;--shiki-dark:#F97583"> class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> A</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  export</span><span style="color:#D73A49;--shiki-dark:#F97583"> class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> B</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  export</span><span style="color:#D73A49;--shiki-dark:#F97583"> const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> a</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ()</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> A</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> B</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// perfectly fine</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  export</span><span style="color:#D73A49;--shiki-dark:#F97583"> const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> b</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ()</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> B</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> A</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// perfectly fine</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">namespace</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> TypeScriptIsJavaScript</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  export</span><span style="color:#D73A49;--shiki-dark:#F97583"> enum</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Types</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    A</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    B</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  export</span><span style="color:#D73A49;--shiki-dark:#F97583"> type</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> A</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="color:#E36209;--shiki-dark:#FFAB70">type</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Types</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">A</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  export</span><span style="color:#D73A49;--shiki-dark:#F97583"> type</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> B</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="color:#E36209;--shiki-dark:#FFAB70">type</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Types</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">B</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  export</span><span style="color:#D73A49;--shiki-dark:#F97583"> const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> a</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ()</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> A</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ({ type: Types.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">B</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// Type 'Types.B' is not assignable to type 'Types.A'.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  export</span><span style="color:#D73A49;--shiki-dark:#F97583"> const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> b</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ()</span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> B</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ({ type: Types.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">A</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// Type 'Types.A' is not assignable to type 'Types.B'.</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>This one is actually quite serious, if your application relies on type safety and objective-oriented-design.</p>
<p>Try doing it in C# (which TS tries to inherit from, iirc) and yo‚Äôll get sane compile-time errors:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">using</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> System</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> A</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> B</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Main</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  A</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> createA</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> B</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// Cannot implicitly convert type `B` to `A`</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  B</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> createB</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> A</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// Cannot implicitly convert type `A` to `B`</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  public</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#D73A49;--shiki-dark:#F97583"> void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="color:#6F42C1;--shiki-dark:#B392F0">args</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="ide-integration-is-awesome">IDE integration is awesome</h3>
<p>Recently I had to use both Cypress and Jest in a project of mine. Cypress was used for E2E tests and Jest was used for unit-tests. And they both provide some sort of assertion framework (think all those <code>expect()</code> calls).</p>
<p>And apparently their definitions are different and are clashing, since my VSCode looks like this:</p>
<img src="/images/strongly-typed-front-end/ts-vscode-integration-1.png" loading="lazy" alt="TS definitions errors in VSCode">
<img src="/images/strongly-typed-front-end/ts-vscode-integration-2.png" loading="lazy" alt="TS definitions errors in VSCode">
<p>Apparently, I needed two separate <code>tsconfig.json</code> files, for each specific set of tests to even compile the thing. Which is still not recognized by VSCode.</p>
<h3 id="errors-can-be-found-and-eliminated-early">Errors can be found and eliminated early</h3>
<p>The helpfulness of the error messages by TS compiler is far from perfect. And same holds for TSLint.</p>
<p>And in some cases (as with type checks), they are even completely missing, so good luck finding out why the application does not work.</p>
<p>It is possible to add a bunch of <code>debugger</code> statements, breakpoints and <code>console.log()</code>s to the code. But what is the benefit of that complex setup and extra overhead of typing every single line then?</p> </div>  </article><article> <h1> <a href="/2021/03/25/2021-03-25-rogue-bomber.html">Rogue bomber</a> </h1> <time datetime="2021-03-25T09:26:24.000Z"> Mar 25, 2021 </time> <div class="content"> <p>This is a yet another show-off blog.</p>
<img src="/images/rogue_bomber/screenshot.webp" loading="lazy">
<p>Yet another one-day-build, made specifically for not-so-exciting ShipIt-51 hackathon we are having at work right now.</p>
<p>This is a terrible code written in JS in matter of some 8 hrs.</p>
<p>Click the button below to start playing.</p>
<div id="rogue-bomber-placeholder"></div>
<p><button id="start-rogue-bomber" class="btn btn-md btn-primary read-more">Play!</button></p>
<script>
window.addEventListener('DOMContentLoaded', () => {
  const bundle = document.createElement('script');

  bundle.onload = () => {
    document.querySelector('#start-rogue-bomber').onclick = () => {
      const canvas = document.createElement('canvas');
      const parent = document.querySelector('#rogue-bomber-placeholder').appendChild(canvas);
      window.__startRogueBomber(canvas);
    };
  };

  bundle.src = '/js/rogue-bomber.js';

  document.body.appendChild(bundle);
});
</script> </div>  </article><article> <h1> <a href="/2021/03/04/2021-03-04-gantt-chart-part3.html">Gantt chart. Part 3</a> </h1> <time datetime="2021-03-04T08:46:24.000Z"> Mar 4, 2021 </time> <div class="content"> <h2 id="contents">Contents</h2>
<ul>
<li><a href="/2017/04/09/gantt-chart-with-d3.html">Gantt chart with D3</a></li>
<li><a href="/2020/08/02/gantt-chart-part2.html">Gantt chart with D3. Part 2</a></li>
<li><a href="/2021/03/04/gantt-chart-part3.html"><strong>Gantt chart with Canvas (you are here)</strong></a></li>
<li><a href="/2024/06/26/gantt-chart-part4.html">Gantt chart with CSS Grids</a></li>
</ul>
<p>I have been writing about and improving on <a href="https://github.com/shybovycha/gantt-chart/">my Gantt chart implementation</a> for quite some time now.</p>
<p>It all started with this (<a href="/2017/04/09/gantt-chart-with-d3.html">blog</a>):</p>
<img src="/images/gantt_chart_part3/gantt-chart-v1.webp" loading="lazy" alt="First revision of Gantt chart">
<p>Then I added few features (<a href="/2020/08/02/gantt-chart-part2.html">blog</a>):</p>
<img src="/images/gantt_chart_part3/gantt-chart-v2.webp" loading="lazy" alt="Second revision of Gantt chart">
<p>Back then I have promised to re-write the implementation in Canvas. And so I did.</p>
<p>Curious fact: I did not plan on doing this at this time - it was a private email from <em>darekeapp12</em> who wrote this:</p>
<blockquote>
I have looked at your blog for Gantt chart and implementation. I am doing a project using React and Node/Express and need to implement Gantt chart that is also draggable i.e. the bars can be moved and also resized from either end. I have researched heavily but could not find anything. I am thinking if there is no library, something could be built from scratch.
</blockquote>
<p>The sender seemed dodgy (<em>DAREKE app</em>) so I did not want to reply to avoid unnecessary spam subscriptions, but I was happy to improve my old project.</p>
<p>Here are few new features and improvements added to the chart:</p>
<ul>
<li>scrolling and zooming in &#x26; out is now a thing</li>
<li>you can drag the milestones around and stretch &#x26; shrink them</li>
<li>an event will be fired whenever a milestone is changed (moved / stretched / shrinked)</li>
<li>dependencies are now typed: start-to-start, end-to-end or end-to-start are the only supported types</li>
</ul>
<p>Here, you can even play around with it now!</p>
<img src="/images/gantt_chart_part3/screenshot.webp" loading="lazy" id="gantt-chart-screenshot">
<div class="chart-container" style="display:none;">
  <div class="controls">
    <button id="zoom-out">-</button>
    <button id="zoom-in">+</button>
  </div>
  <div id="gantt-chart"></div>
</div>
<script>
window.addEventListener('DOMContentLoaded', () => {
  const chartScreenshot = document.querySelector('#gantt-chart-screenshot');
  const chartContainer = document.querySelector('.chart-container');

  const bundle = document.createElement('script');

  bundle.onload = () => {
    chartContainer.style.display = 'block';
    chartScreenshot.parentElement.removeChild(chartScreenshot);
  };

  bundle.src = '/js/gantt-chart.bundle.js';

  document.body.appendChild(bundle);
});
</script>
<p>More about the implementation specifics under the cut.</p>
<!--more-->
<div class="content-read-marker" data-fraction="50"></div>
<p>The main goal I had in mind was getting rid of D3, since it is a rather heavy dependency which is only used for few rather simple functions.
By the end of this rework I ended up adding a ton of visual and functional improvements to the implementation, but I‚Äôll talk about it in detail later.</p>
<p>To start with, I created a function to convert a timestamp into a position on canvas. This requires knowing the boundaries of timeline and canvas
to be able to map the beginning of a timeline to a beginning of canvas. I started off by trying to figure out the formulae myself, but quickly realized
it is not as simple as few additions and divisions (well, it actually is, but it is tricky to figure out from start). So I turned myself to the maths -
linear interpolation, to be specific.</p>
<p>If we know the beginning of a range and the end of a range and values they map to, in  order to figure out the corresponding mapping of a point on that
range, we can utilize linear interpolation (given the range values changes linearly, which is true, since we work with time span on one hand and canvas
coordinates on the other).</p>
<p>Here‚Äôs a visual representation of what I am talking about:</p>
<img src="/images/gantt_chart_part3/interpolation.png" loading="lazy" alt="Interpolation explained">
<p>There‚Äôs a formulae to tell the <code>y</code> coordinate of a point on a line by its <code>x</code> coordinate if you know two points on that line.</p>
<p>Now in our case, the two known points are the start and the end of the time span.
<em>‚ÄúBut wait, why are we even taling about <code>x</code> and <code>y</code> coordinates?‚Äù</em> - you might ask.
A given timestamp can be represented as a single number (number of milliseconds since Unix was started).
That would give us the <code>x</code> coordinate of any given point. The <code>y</code> coordinate would be the <code>x</code> coordinate of the same point
on canvas. We do not care about the <code>y</code> coordinate on canvas, since all the vertical layout will be done later and does not
depend on the timestmap. We will have to arrange elements on the canvas vertically in a different order, so we can easily exclude it
from the interpolation.</p>
<p>Let‚Äôs reiterate the formulae:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>y = y1 + (x - x1) * ((y2 - y1) / (x2 - x1))</span></span>
<span class="line"><span></span></span></code></pre>
<p>Considering the explanation above:</p>
<ul>
<li><code>x1</code> is the first timestamp from the time span on a screen</li>
<li><code>y1</code> is the lowest of canvas‚Äô <code>x</code> coordinate (<code>0</code>)</li>
<li><code>x2</code> is the last timestamp from the time span on a screen</li>
<li><code>y2</code> is the highest of canvas‚Äô <code>x</code> coordinate (<code>canvas.width</code>)</li>
<li><code>x</code> is a numeric timestamp value</li>
<li><code>y</code> is a corresponding <code>x</code> coordinate of that timestamp on canvas</li>
</ul>
<p>Substitute these in the formulae:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>y = 0 + (x - firstTimestamp) * ((canvas.width - 0) / (lastTimestamp - firstTimestamp))</span></span>
<span class="line"><span></span></span></code></pre>
<p>And simplify it:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>y = (x - firstTimestamp) * (canvas.width / (lastTimestamp - firstTimestamp))</span></span>
<span class="line"><span></span></span></code></pre>
<p>In terms of code, the interpolation function looks like this:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">scaleX</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(date, minStart, overallDuration, canvasWidth) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Math.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">ceil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">((date.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">getTime</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> minStart) </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (canvasWidth </span><span style="color:#D73A49;--shiki-dark:#F97583">/</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> overallDuration));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Now, for a given canvas size and time span range we can figure out the <code>x</code> coordinate of <em>any</em> date (even if it is far out from the time span -
this will actually give us the ability to scroll the chart). Hence we can start drawing both milestones and current time line (marking ‚Äúnow‚Äù on a chart).
It is as easy as figuring out the coresponding <code>y</code> coordinate of an object you want to render. For instance, the current time line would start with <code>y = 0</code> and
end at <code>y = canvas.height</code>. The milestone bars, however, could have their <code>y</code> coordinate calculated as <code>y = milestoneIndex * (milestoneHeight + (verticalPadding * 2))</code>.</p>
<p>And that is what makes the core of the new chart implementation. The rest is a ton of fanciness in form of pretty colors, drag&#x26;drop milestones (updating the underlying data)
and scaling them, rendering connection lines between them. For the most part it is a combination of plain JS and Canvas API.</p>
<p>The only trick-ier bit is moving and resizing the milestones - if you want to update the underlying milestone data, you will need to have an inverse
of linear interpolation above - you will need to figure out the date based on <code>x</code> coordinate on canvas. This is as simple as swapping the parameters in the interpolation:
instead of <code>y</code> variable representing the <code>x</code> coordinate on canvas, it should represent the date on the time span and <code>x</code> variable should represent the <code>x</code> coordinate
on canvas:</p>
<ul>
<li><code>y1</code> is the first timestamp from the time span on a screen</li>
<li><code>x1</code> is the lowest of canvas‚Äô <code>x</code> coordinate (<code>0</code>)</li>
<li><code>y2</code> is the last timestamp from the time span on a screen</li>
<li><code>x2</code> is the highest of canvas‚Äô <code>x</code> coordinate (<code>canvas.width</code>)</li>
<li><code>y</code> is a numeric timestamp value</li>
<li><code>x</code> is a corresponding <code>x</code> coordinate of that timestamp on canvas</li>
</ul>
<p>In JS it looks like this:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">scaleDate</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(x, minStart, overallDuration, canvasWidth) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Math.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">ceil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(minStart.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">getTime</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (x </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (overallDuration </span><span style="color:#D73A49;--shiki-dark:#F97583">/</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> canvasWidth)));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Using Canvas for this project sounds reasonable, especially given the time span can potentially be very large. This also enables rendering nice controls and
connection (dependency) lines.</p>
<p>However, the big disadvantage of using Canvas is the complexity to use the custom HTML elements for description or other milestone details
(for instance, to show the additional details about mileston - goal, assignee, etc.).</p>
<p>This is the reason this implementation is still not a standalone React component - I am still trying to figure out the best way to render the chart.</p>
<p>Anyhow, that‚Äôs it for now. I will improve this solution when the time comes.</p>
<div class="content-read-marker" data-fraction="100"></div> </div>  </article><article> <h1> <a href="/2020/11/13/2020-11-13-shootthem-revival.html">ShootThem! revival</a> </h1> <time datetime="2020-11-13T02:46:24.000Z"> Nov 13, 2020 </time> <div class="content"> <p>Quite some time ago I <a href="/tumblr/2015/04/06/shootthem.html">dag out</a> the sources of an old game of mine, ShootThem! made back when I was at high-school, around 2006.</p>
<p>It has been over a decade ever since I made that game and I had enough inspiration to revisit the code once again.</p>
<p>This is a short update blog about what it used to be and what it became as of now.</p>
<div><img src="/images/shootthem-revival/ShootThem 15_09_2020 8_19_43 AM.webp" loading="lazy"></div>
<div><img src="/images/shootthem-revival/ShootThem 26_09_2020 8_19_43 PM.webp" loading="lazy"></div>
<div><img src="/images/shootthem-revival/square1_render2.webp" loading="lazy"></div>
<!--more-->
<h2 id="2006">2006</h2>
<p>Back in 2006 I have barely learned some OOP and C / C++, just enough to be able to use it in school programming competitions.</p>
<p>The game looked awful - there were no textures in the whole game, the models were mostly hand-made by myself in some dodgy 3D editor
(Calligra TrueSpace or something alike).</p>
<div><img src="/images/shootthem-revival/ShootThem 13_09_2020 10_18_45 PM.webp" loading="lazy"></div>
<div><img src="/images/shootthem-revival/ShootThem 13_09_2020 10_18_52 PM.webp" loading="lazy"></div>
<div><img src="/images/shootthem-revival/ShootThem 15_09_2020 8_19_36 AM.webp" loading="lazy"></div>
<div><img src="/images/shootthem-revival/ShootThem 15_09_2020 8_19_43 AM.webp" loading="lazy"></div>
<p>The code was terrible as well - static variables, huge functions, not to mention the whole game was a huge hard-coded, non-configurable mess in one <code>main.cpp</code> file.</p>
<div><img src="/images/shootthem-revival/Screen Shot 2020-11-13 at 2.02.28 pm.webp" loading="lazy"></div>
<p>But there was also a map editor, which allowed for some customization - it was basically a first-person camera and few magical buttons that allowed to define target positions for a specific level. The level mesh and output file were both provided via command-line arguments.</p>
<h2 id="2015">2015</h2>
<p>I have dag out the sources and decided to put them on GitHub for historical reference. I have also managed to set up CMake for the thing
so that it could be built on <em>any</em> computer without bothering too much about magical compiler options and everything.</p>
<h2 id="2020">2020</h2>
<p>I have started the rework. First things first, I reworked the CMake configuration to a modern style and replaced the dependency ‚Äúmanagement‚Äù (essentially an instruction to manually unzip Irrlich and IrrKlang files and put them in specific directories) with CMake‚Äôs <code>Fetch</code> module.</p>
<p>Then I thought about reshaping the code, so I have split one big <code>main.cpp</code> file with static variables and a handful of functions into classes, encapsulating the logic - <code>Level</code>, <code>Score</code>, <code>PlayerState</code>, <code>GameState</code>. This allowed me to maintain the working state of the game whilst actually improving the state of the code (<a href="https://github.com/shybovycha/shoot-them/commit/b49b478e76c33fd59c5b1960127b21a1039fce9a">commit</a>).</p>
<p>I have also extracted the settings into a separate file, <code>settings.xml</code> so that the application can be actually somewhat configured. Also, the magical data format for the levels was replaced with much more readable XML, <code>levels.xml</code>:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="xml"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#22863A;--shiki-dark:#85E89D">levels</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  &#x3C;</span><span style="color:#22863A;--shiki-dark:#85E89D">level</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    &#x3C;</span><span style="color:#22863A;--shiki-dark:#85E89D">model</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>room1.dae&#x3C;/</span><span style="color:#22863A;--shiki-dark:#85E89D">model</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    &#x3C;</span><span style="color:#22863A;--shiki-dark:#85E89D">entities</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      &#x3C;</span><span style="color:#22863A;--shiki-dark:#85E89D">light</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        &#x3C;</span><span style="color:#22863A;--shiki-dark:#85E89D">position</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> x</span><span style="color:#24292E;--shiki-dark:#E1E4E8">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"-717.96405029296875"</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> y</span><span style="color:#24292E;--shiki-dark:#E1E4E8">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"129.1875"</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> z</span><span style="color:#24292E;--shiki-dark:#E1E4E8">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"200"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      &#x3C;/</span><span style="color:#22863A;--shiki-dark:#85E89D">light</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      &#x3C;</span><span style="color:#22863A;--shiki-dark:#85E89D">light</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">          &#x3C;</span><span style="color:#22863A;--shiki-dark:#85E89D">position</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> x</span><span style="color:#24292E;--shiki-dark:#E1E4E8">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"0"</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> y</span><span style="color:#24292E;--shiki-dark:#E1E4E8">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"125.34170532226563"</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> z</span><span style="color:#24292E;--shiki-dark:#E1E4E8">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"258.18295288085938"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      &#x3C;/</span><span style="color:#22863A;--shiki-dark:#85E89D">light</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      &#x3C;</span><span style="color:#22863A;--shiki-dark:#85E89D">target</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">          &#x3C;</span><span style="color:#22863A;--shiki-dark:#85E89D">position</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> x</span><span style="color:#24292E;--shiki-dark:#E1E4E8">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"-765.06158447265625"</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> y</span><span style="color:#24292E;--shiki-dark:#E1E4E8">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"271.0589599609375"</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> z</span><span style="color:#24292E;--shiki-dark:#E1E4E8">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"670.49334716796875"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      &#x3C;/</span><span style="color:#22863A;--shiki-dark:#85E89D">target</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">      &#x3C;!-- ... --></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    &#x3C;/</span><span style="color:#22863A;--shiki-dark:#85E89D">entities</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  &#x3C;/</span><span style="color:#22863A;--shiki-dark:#85E89D">level</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;/</span><span style="color:#22863A;--shiki-dark:#85E89D">levels</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"></span></code></pre>
<p>Next step was to reduce the coupling of code components and introduce some sort of state management. I am still unhappy with what I ended up with, but it is still infinitely better than one single <code>main()</code> function.</p>
<p>I have ended up with something similar to Redux from front-end world (at least that was an initial plan) - there is a <em>Store</em>, where the state is stored; there are <em>Actions</em>, which define a change to the state; there is a <em>Reducer</em>, which modifies the state of the app; and finally, there are <em>Subscribers</em> which react to state changes and render the state of the app.</p>
<p>But the issue was that there are many <em>effects</em> to handle like playing sound, loading and unloading the data, etc.</p>
<p>Along the way I have also kept maintaining a list of things I was thinking about - bugs found, improvements, refactoring ideas, etc (<a href="https://github.com/shybovycha/shoot-them/commits/master/README.md">README.md history</a>).</p>
<p>Few improvements included adding a main menu, replacing the ‚ÄúUI‚Äù with something more user-friendly (previously it was just an ugly line of text), improving the ‚Äúdrunk shooter‚Äù effect (ended up replacing it with shaders, which is not a trivial task in Irrlicht - more on that later).</p>
<div><img src="/images/shootthem-revival/ShootThem 20_09_2020 2_48_59 PM.webp" loading="lazy"></div>
<div><img src="/images/shootthem-revival/ShootThem 26_09_2020 8_19_43 PM.webp" loading="lazy"></div>
<p>I have also started reworking the 3D models for the game and decided it was a good point to just show how I <em>meant</em> the original art to be in the game:</p>
<div><img src="/images/shootthem-revival/egypt1_render.webp" loading="lazy"></div>
<div><img src="/images/shootthem-revival/forest1_render.webp" loading="lazy"></div>
<div><img src="/images/shootthem-revival/square1_render2.webp" loading="lazy"></div>
<p>The art is still far from being ready, but here‚Äôs a preview of the new training level:</p>
<div><img src="/images/shootthem-revival/blender_shooting_range3.webp" loading="lazy"></div>
<p>The editor was also reworked‚Ä¶ Or better being said, made from scratch - now it actually has a GUI, it allows to manage all the levels without restarting the app, it allows to place targets and move them around, it allows to place light sources on the scene and it is not a first-person camera anymore.</p>
<div><img src="/images/shootthem-revival/Shoot Them Editor 26_09_2020 1_09_03 PM.webp" loading="lazy"></div>
<div><img src="/images/shootthem-revival/Shoot Them Editor 26_09_2020 1_12_56 PM.webp" loading="lazy"></div>
<div class="content-read-marker" data-fraction="25"></div>
<h2 id="lessons-learned">Lessons learned</h2>
<p>There are quite a few lessons that I have learned.</p>
<h3 id="cmake-sucks-a-lot">CMake sucks. A lot.</h3>
<p>I freaking hate CMake for a few very good reasons:</p>
<ul>
<li>awful syntax, it is still same good old Make, just with syntax being wrecked</li>
<li>lack of any structure to the projects - everyone does it in their own preferred way, so no one will actually tell you <em>the way</em> to set up your project</li>
<li>the lack of dependency managemen - which, in 2020, seems like a huge drawback, especially if you don‚Äôt develop every single bit of your application from scratch</li>
<li>performance - yes, performance - by default it performs a clean build every time - it compiles <em>everything</em> from scratch every time you change anything</li>
<li>documentation - no one will tell you <em>the way to do it</em>; most manuals and articles still rely on CMake 2.6 or 3.0 at best; a lot of information online is so dispersed, inconsistent and out-of-date - you will be surprised!</li>
</ul>
<p>The only reason I use CMake is because all the dependencies I use <em>could</em> be used with CMake. Well, except Irrlicht and IrrKlang.</p>
<p>I thought Bazel or Buck will be better, but they still require one to create custom build instructions for those dependencies and it is especially hard for a cross-platform libraries such as Irrlicht. Well, at least they do solve most of CMake issues I have listed above.</p>
<h3 id="irrlicht-is-old">Irrlicht is old</h3>
<p>It is <em>extremely</em> old - last <em>bugfix</em> version, <code>1.8.4</code>, was released on <code>9th July 2016</code> (which is only 4.5 years ago as of now) and the corresponding minor version, <code>1.8.0</code> being released on <code>8th November 2012</code> (8 years ago as of now).</p>
<p>It might not seem like a <em>huge</em> deal, but here are few things that I have noticed:</p>
<ul>
<li>shaders are hard to get working</li>
<li>only GLSL and HSL are supported</li>
<li>no frame buffer support</li>
<li>renderers are OpenGL 3 and DirectX 9</li>
<li>out-of-the-box tools are quite limited:
<ul>
<li>camera movement is either Maya-style, First-Person-Shooter-style or manual control, through matrices and vectors</li>
<li>the GUI out of the box is not suited for high-resolution monitors with fonts being pixelated</li>
<li>overall a lot of bugs with GUI (random events missed or fired)</li>
</ul>
</li>
<li>ray-picking is buggy</li>
<li>textures / lighting is buggy as heck (sometimes textures are disappearing, separate mesh triangles being shaded differently from others, etc.)</li>
<li>anti-aliasing not working properly for sprites (which makes my HUD look ugly most of the time, even though it is high-res images)</li>
</ul>
<p>Check these screenshots for example:</p>
<div><img src="/images/shootthem-revival/ShootThem 26_09_2020 8_19_30 PM.webp" loading="lazy"></div>
<div><img src="/images/shootthem-revival/ShootThem 26_09_2020 8_19_43 PM.webp" loading="lazy"></div>
<p>It is the same scene, with lighting being messed up for <em>all target models</em> on the latter screenshot.</p>
<p>With the subset of APIs that are needed for my game, I am quite seriously considering just sticking to lower-level graphics APIs (OpenGL / DirectX) and stepping away from Irrlicht.</p>
<h3 id="c-is-not-easy">C++ is not easy</h3>
<p>With the idea of having redux-like state management and the strong type system of C++ I thought it would be a good idea to leverage the compiler and language features to do some compile-time checks for the actions that are being dispatched. I started with templates, but then figured out (the most painful way possible) that templates are merely hints for compiler.</p>
<p>Also, one can not define method overrides for the base class of the hierarchy by specifying child class as method param.</p>
<p>So my initial design like below fell apart very quickly:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> BaseAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> PlaySoundAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> BaseAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  public:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::string filename;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> DestroyEntityAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> BaseAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  public:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::shared_ptr</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">Entity</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> entity;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// ---</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> BaseReducer</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  public:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    virtual</span><span style="color:#D73A49;--shiki-dark:#F97583"> void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> processAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">BaseAction</span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#E36209;--shiki-dark:#FFAB70"> action</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Reducer</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> BaseReducer</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  public:</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // error: 'processAction' marked 'override' but does not override any member functions</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    virtual</span><span style="color:#D73A49;--shiki-dark:#F97583"> void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> processAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">DestroyEntityAction</span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#E36209;--shiki-dark:#FFAB70"> action</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">override</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">      // ...</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // error: 'processAction' marked 'override' but does not override any member functions</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    virtual</span><span style="color:#D73A49;--shiki-dark:#F97583"> void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> processAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">PlaySoundAction</span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#E36209;--shiki-dark:#FFAB70"> action</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">override</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">      // ...</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// ---</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Store</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  private:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::unique_ptr</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">BaseReducer</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> reducer;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::queue</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">BaseAction</span><span style="color:#D73A49;--shiki-dark:#F97583">*></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> actionQueue;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> processQueue</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      while</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">!</span><span style="color:#24292E;--shiki-dark:#E1E4E8">actionQueue.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">empty</span><span style="color:#24292E;--shiki-dark:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        auto</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> action </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> actionQueue.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">front</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        actionQueue.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">pop</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">        // error: no matching member function for call to 'processAction'</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        reducer-></span><span style="color:#6F42C1;--shiki-dark:#B392F0">processAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(action);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span></code></pre>
<div class="content-read-marker" data-fraction="50"></div>
<p>Templates won‚Äôt solve the issue either:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> BaseReducer</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  public:</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    // only this method will be called every time</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    template</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> &#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> T</span><span style="color:#24292E;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> processAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">T</span><span style="color:#E36209;--shiki-dark:#FFAB70"> action</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::cout </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;&#x3C;</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "processing unknown action"</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x3C;&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::endl;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Reducer</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> BaseReducer</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  public:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> processAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">DestroyEntityAction</span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#E36209;--shiki-dark:#FFAB70"> action</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      BaseReducer</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">processAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(action);</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::cout </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;&#x3C;</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "destroying an object"</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x3C;&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::endl;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> processAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">PlaySoundAction</span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#E36209;--shiki-dark:#FFAB70"> action</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      BaseReducer</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#6F42C1;--shiki-dark:#B392F0">processAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(action);</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::cout </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;&#x3C;</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "playing a sound"</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x3C;&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::endl;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span></code></pre>
<p>Also, a template method can‚Äôt be virtual.</p>
<p>So here comes another trick front-end developers use, the <code>type</code> field for actions and <code>switch..case</code> statement in reducer:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> BaseReducer</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  public:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    virtual</span><span style="color:#D73A49;--shiki-dark:#F97583"> void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> processAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">BaseAction</span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#E36209;--shiki-dark:#FFAB70"> action</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Reducer</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> : </span><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> BaseReducer</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  public:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    virtual</span><span style="color:#D73A49;--shiki-dark:#F97583"> void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> processAction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">BaseAction</span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#E36209;--shiki-dark:#FFAB70"> action</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">override</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">      switch</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (action->type) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        case</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> ActionType</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::PLAY_SOUND:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">          std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::cout </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;&#x3C;</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "playing a sound"</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x3C;&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::endl;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        break</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        case</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> ActionType</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::DESTROY_ENTITY:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">          std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::cout </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;&#x3C;</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "destroying an object"</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x3C;&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::endl;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        break</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        default</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">          std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::cout </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;&#x3C;</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "unknown action"</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x3C;&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> std</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::endl;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span></code></pre>
<h3 id="editor-is-really-important">Editor is really important</h3>
<p>My game has multiple levels. Each level requires its own lighting and target placement. It is quite hard to do properly without the editor.
And the first version of my ‚Äúeditor‚Äù has proven that.</p>
<p>Even the new version of editor lacks lots of features - one still can‚Äôt rotate the targets or see the actual targets, there are no particle emitters available, there are no scene-specific events that would have allowed some neat mechanics.</p>
<p>And finally, it is hard to see the result in the editor itself - there will be differences with the game.</p>
<p>However, I did consider using GoDot engine for the game.</p>
<p>There are features that I really liked about it.</p>
<h4 id="i18n-support">I18n support</h4>
<div><img src="/images/shootthem-revival/Screen Shot 2020-08-26 at 9.58.10 am.webp" loading="lazy"></div>
<h4 id="configurable-user-actions">Configurable user actions</h4>
<p>This way you can have same handler for gamepad buttons‚Äô and keyboard/mouse input events:</p>
<div><img src="/images/shootthem-revival/Screen Shot 2020-08-26 at 9.57.58 am.webp" loading="lazy"></div>
<h4 id="attaching-scripts-to-any-object-on-the-scene">Attaching scripts to any object on the scene</h4>
<p>This allows for a magnitude of interesting mechanics.</p>
<div><img src="/images/shootthem-revival/Screen Shot 2020-08-26 at 9.55.19 am.webp" loading="lazy"></div>
<p>For a number of reasons I didn‚Äôt choose it - there were some user experience issues significantly reducing my productivity.</p>
<div class="content-read-marker" data-fraction="75"></div>
<h4 id="asset-management">Asset management</h4>
<p>Sspecifically the neccesity to specify every single texture for every single object on a scene. Check out this chicken model:</p>
<div><img src="/images/shootthem-revival/Screen Shot 2020-08-26 at 9.55.34 am.webp" loading="lazy"></div>
<p>It is just an OBJ file with every material specified:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>mtllib chicken.mtl</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 262 vertex positions</span></span>
<span class="line"><span>v  18.556948 41.779099 -12.354659</span></span>
<span class="line"><span>v  20.53804 50.283123 -13.547608</span></span>
<span class="line"><span></span></span>
<span class="line"><span># ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Mesh '0' with 68 faces</span></span>
<span class="line"><span>g 0</span></span>
<span class="line"><span>usemtl Material #1</span></span>
<span class="line"><span>f  1/1/1 2/2/2 3/3/3</span></span>
<span class="line"><span>f  3/3/3 2/2/2 4/4/4</span></span>
<span class="line"><span></span></span>
<span class="line"><span># ...</span></span>
<span class="line"><span></span></span></code></pre>
<p>Yet in the editor you‚Äôll have to manually assign every single material to every single sub-mesh:</p>
<div><img src="/images/shootthem-revival/Screen Shot 2020-08-26 at 9.56.56 am.webp" loading="lazy"></div>
<h4 id="not-really-clear-scene-node-types">Not really clear scene node types</h4>
<p>Now which node do I use for kinematic physical body?</p>
<div><img src="/images/shootthem-revival/Screen Shot 2020-08-26 at 10.10.15 am.webp" loading="lazy"></div>
<p>Just what the heck is ‚Äúspatial‚Äù and why does it have both ‚Äúcamera‚Äù and ‚Äúcollision shape‚Äù next to ‚Äúaudio stream‚Äù?</p>
<div><img src="/images/shootthem-revival/Screen Shot 2020-08-26 at 10.10.20 am.webp" loading="lazy"></div>
<h4 id="lack-of-any-sort-of-pre-made-solutions">Lack of any sort of pre-made solutions</h4>
<p>So that every time you need an FPS camera - you have to define it from zero, using the matrix transformations. This increases the amount of boilerplate code and actually reduces the productivity even compared to Irrlicht:</p>
<div><img src="/images/shootthem-revival/Screen Shot 2020-08-26 at 9.55.19 am.webp" loading="lazy"></div>
<h2 id="this-is-not-the-end">This is not the end</h2>
<p>I am not done with this project revival just yet - I still want it to build under OSX and I still have few assets to put into the game.
Also, the plot is still not very clear, so I‚Äôd better come up with something rather interesting.
Stay tuned for more updates!</p>
<div class="content-read-marker" data-fraction="100"></div> </div>  </article><article> <h1> <a href="/2020/11/07/2020-11-07-erlang-example-2.html">Erlang example 2.0</a> </h1> <time datetime="2020-11-07T02:42:24.000Z"> Nov 7, 2020 </time> <div class="content"> <p>Quite some time ago I‚Äôve published a <a href="/tumblr/2015/01/28/erlang-practice.html">blogpost about Erlang</a>. It claimed to present a <em>short intro to distributed programming in Erlang</em>. But it turned to be a very simple communication application, nothing super-exciting.</p>
<p>In this post I would like to elaborate more on the topic of Erlang, for a number of reasons:</p>
<ul>
<li>it is a pretty simple language itself</li>
<li>the distributed systems topic gets more and more of my attention these days</li>
<li>when I was looking at Erlang, I would love to see a more advanced tutorial myself <em>(more practical things and more Erlang platform features showcased)</em></li>
</ul>
<!--more-->
<h2 id="language-features">Language features</h2>
<p>Kicking off with the language features, let‚Äôs discover few data structures available out of the box.</p>
<p>I was thinking for few a while about what could be showcased in Erlang. I think the system we‚Äôll develop closer to the end of this blog
is quite nice.</p>
<h3 id="tuples">Tuples</h3>
<p>As you might remember from the <a href="/2020/01/10/erlang-in-5-minutes.html">quick introduction to Erlang</a>, tuples are defined like this:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">X </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">elt1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">elt2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">elt3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">elt5</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }.</span></span>
<span class="line"></span></code></pre>
<p>Now, since there are no datatypes or alike in Erlang, we can use tuples to denote complex data structures, like trees, for example:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">Tree </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Parent, Left, Right }.</span></span>
<span class="line"></span></code></pre>
<p>With this, let us create a module to work with binary trees:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">module</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">binary_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([</span><span style="color:#6F42C1;--shiki-dark:#B392F0">create_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">create_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(N) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, N, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Parent, Left, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">>=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    NewNode </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> create_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Value),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Parent, Left, NewNode };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Parent, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Right }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    NewNode </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> create_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Value),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Parent, NewNode, Right };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Parent, Left, Right }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">>=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Parent, Left, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Right, Value) };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Parent, Left, Right }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Parent, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Left, Value), Right }.</span></span>
<span class="line"></span></code></pre>
<p>The idea behind <code>insert_into_tree/2</code> is that every call has to return the copy of a current tree with a recursively modified leaf.</p>
<p>Now, to test the binary tree, we can define a function that checks if a node is in tree or not:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Value) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> false</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Left, Right }, Value) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> false</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Parent, Left, Right }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">=:=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Parent, Left, Right }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">>=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Right, Value);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Parent, Left, Right }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Left, Value).</span></span>
<span class="line"></span></code></pre>
<p>You might want to compile the module now, by running</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">$erlc binary_tree.erl</span></span>
<span class="line"></span></code></pre>
<p>We can run the program to construct a tree and check if some element is in there:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">binary_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">start</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Tree </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">create_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">), </span><span style="color:#005CC5;--shiki-dark:#79B8FF">15</span><span style="color:#24292E;--shiki-dark:#E1E4E8">), </span><span style="color:#005CC5;--shiki-dark:#79B8FF">10</span><span style="color:#24292E;--shiki-dark:#E1E4E8">), </span><span style="color:#005CC5;--shiki-dark:#79B8FF">22</span><span style="color:#24292E;--shiki-dark:#E1E4E8">), </span><span style="color:#005CC5;--shiki-dark:#79B8FF">12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  X1 </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 7</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  X2 </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  X1Present </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">7</span><span style="color:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  X2Present </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  io</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">fwrite</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Tree: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">~p~n</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [Tree]),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  io</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">fwrite</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#005CC5;--shiki-dark:#79B8FF">~p</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> in tree (</span><span style="color:#005CC5;--shiki-dark:#79B8FF">~p</span><span style="color:#032F62;--shiki-dark:#9ECBFF">)</span><span style="color:#005CC5;--shiki-dark:#79B8FF">~n</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [X1, X1Present]),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  io</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">fwrite</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#005CC5;--shiki-dark:#79B8FF">~p</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> in tree (</span><span style="color:#005CC5;--shiki-dark:#79B8FF">~p</span><span style="color:#032F62;--shiki-dark:#9ECBFF">)</span><span style="color:#005CC5;--shiki-dark:#79B8FF">~n</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [X2, X2Present]).</span></span>
<span class="line"></span></code></pre>
<p>This is a bit cumbersome, so let‚Äôs use the <code>lists:foldl/3</code> function together with a list of values to construct the tree in a more convenient way:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">lists</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#6F42C1;--shiki-dark:#B392F0">foldl</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">start</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Values </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">15</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">20</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">22</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">10</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">5</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">4</span><span style="color:#24292E;--shiki-dark:#E1E4E8">],</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Tree </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> lists</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">foldl</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Elt, Acc) -> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Acc, Elt) </span><span style="color:#D73A49;--shiki-dark:#F97583">end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">create_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">), Values)</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  % ...</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span></span>
<span class="line"></span></code></pre>
<h3 id="records">Records</h3>
<p>There is a mechanism in Erlang called <em>records</em>. It is basically a syntactic sugar around tuples, just as we have used them above, but it gives a little bit more clarity for pattern matching when writing code:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">record</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, { value, left, right }).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">create_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(N) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#D73A49;--shiki-dark:#F97583"> #</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> N, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Left, right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">>=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    NewNode </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> create_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Value),</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    #</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Left, right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> NewNode };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Right }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    NewNode </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> create_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Value),</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    #</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> NewNode, right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Right };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Left, right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Right }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">>=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    #</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Left, right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Right, Value) };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Left, right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Right }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    #</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Left, Value), right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Right }.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">_</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> false</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> _</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> _</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">_</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> false</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> _</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> _</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">=:=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> _</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Right }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">>=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Right, Value);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Left, right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> _</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Parent </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Left, Value).</span></span>
<span class="line"></span></code></pre>
<div class="content-read-marker" data-fraction="25"></div>
<p>Well, it does make pattern matching more explicit, but the code has just blown up!
Luckily, Erlang does provide a syntactic sugar to read a specific field of a record and to update specific record‚Äô fields:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.right </span><span style="color:#D73A49;--shiki-dark:#F97583">=:=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Value </span><span style="color:#D73A49;--shiki-dark:#F97583">>=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.value </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#6A737D;--shiki-dark:#6A737D"> % read specific fields from Tree, namely - right and value</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    NewNode </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> create_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Value),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> NewNode }; </span><span style="color:#6A737D;--shiki-dark:#6A737D">% update only the tree.right value, leave the rest values of Tree unchanged</span></span>
<span class="line"></span></code></pre>
<p>This makes a module a bit shorter again:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">record</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, { value, left, right }).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">create_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(N) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#D73A49;--shiki-dark:#F97583"> #</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> N, left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.right </span><span style="color:#D73A49;--shiki-dark:#F97583">=:=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Value </span><span style="color:#D73A49;--shiki-dark:#F97583">>=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.value </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    NewNode </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> create_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Value),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> NewNode };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.left </span><span style="color:#D73A49;--shiki-dark:#F97583">=:=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Value </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.value </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    NewNode </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> create_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Value),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> NewNode };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">>=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.value </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ right </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.right, Value) };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.value </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ left </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> insert_into_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.left, Value) }.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">nil</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">_</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> false</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.value </span><span style="color:#D73A49;--shiki-dark:#F97583">=:=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    true</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">>=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.value </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.right, Value);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree, Value)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.value </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    is_in_tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tree</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">tree</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.left, Value).</span></span>
<span class="line"></span></code></pre>
<h3 id="maps">Maps</h3>
<p>Well, having records is good and nice. But what if we want a hashmap?
Consider a trie data structure, where it has a value and a map of characters to nodes.
Technically, we could have a list of nodes and iterate over them whenever we need to access a specific child.
But that would be a waste of time.</p>
<p>Luckily, Erlang does provide the <code>maps</code> module:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">module</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">trie</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">lists</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#6F42C1;--shiki-dark:#B392F0">foldl</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]).</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">maps</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#6F42C1;--shiki-dark:#B392F0">is_key</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">put</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([</span><span style="color:#6F42C1;--shiki-dark:#B392F0">new</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">insert</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">contains</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">record</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">trie</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, { stop, children }).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">new</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#D73A49;--shiki-dark:#F97583"> #</span><span style="color:#6F42C1;--shiki-dark:#B392F0">trie</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ stop </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> false</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, children </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> #{} }.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Trie, []) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Trie</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">trie</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { stop </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">insert</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Trie, [Char|Chars]) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Children </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Trie</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">trie</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.children,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  IsChild </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> maps</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">is_key</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Char, Children),</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  if</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    IsChild </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> -></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      SubTrie </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> maps</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Char, Children),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      NewSubTrie </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> insert</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(SubTrie, Chars),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      NewChildren </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> maps</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">put</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Char, NewSubTrie, Children),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      Trie</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">trie</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { children </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> NewChildren };</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    true</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> -></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      SubTrie </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> new</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      NewSubTrie </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> insert</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(SubTrie, Chars),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      NewChildren </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> maps</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">put</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Char, NewSubTrie, Children),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      Trie</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">trie</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { children </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> NewChildren }</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">contains</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Trie, []) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Trie</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">trie</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.stop;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">contains</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Trie, [Char|Chars]) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Children </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Trie</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">trie</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.children,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  IsChild </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> maps</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">is_key</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Char, Children),</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  if</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    IsChild </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> -></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      SubTrie </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> maps</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Char, Children),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      contains</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(SubTrie, Chars);</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    true</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> -></span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">      false</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span></code></pre>
<p>Quite unfortunately, pretty much none of the handy maps syntax is implemented yet.</p>
<h2 id="platform-features">Platform features</h2>
<p>Let‚Äôs start with few simple but practical examples.</p>
<h3 id="web-server">Web-server</h3>
<p>Erlang comes packed with a lot of features. One of them is bundled web-server. Some time ago I‚Äôve published a post about a very simple Tetris game, which I‚Äôve crafted one evening. The thing is: that game is nothing more than a single HTML page. What we can do now is start a web server, which will listen for connections on <code>8080</code> port and serve them a static file with the game.</p>
<p>The code is pretty simple:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">module</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">simple_web_server</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([ </span><span style="color:#6F42C1;--shiki-dark:#B392F0">run_server</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">stop_server</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">run_server</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  inets</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">start</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  inets</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">start</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">httpd</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [{ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">port</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">8080</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">server_name</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"httpd_test"</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">server_root</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"."</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">document_root</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"."</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">bind_address</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">any</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">stop_server</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Pid) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  inets</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">stop</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">httpd</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Pid).</span></span>
<span class="line"></span></code></pre>
<p>But modern web applications require a server that will have some sort of an API. Take REST for example - when a URL of a specific format with specific HTTP method (<code>GET</code>, <code>PUT</code>, <code>POST</code>, <code>DELETE</code>, etc.) is hit on the server, some behaviour is expected. For instance, <code>curl -X GET http://server.address/posts</code> request is expected to return a list of all <code>Post</code> entities (whatever that means in the context of an application), whereas <code>curl -X PUT http://server.address/posts -d '{ "title": "post #1", "content": "blah" }' -H "Content-Type: application/json"</code> is expected to create a <code>Post</code> entity with fields <code>title</code> and <code>content</code> from the request.</p>
<p>The bundled Erlang HTTP server, <code>httpd</code> kind of allows for that, except the URLs will be in a format <code>cgi-bin/erl/mymodule:mymethod</code>, which is not exactly what we want.
But just for the sake of example, here‚Äôs how it would look like implemented with httpd:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">module</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">posts</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">all</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">create</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(SessionID, Env, Input) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mod_esi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">deliver</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(SessionID, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Content-Type:application/json</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\r\n\r\n</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mod_esi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">deliver</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(SessionID, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">do_get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Input)).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">do_get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Input) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  QueryParams </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> uri_string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">dissect_query</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Input),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  { _IdParamName, Id } </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> lists</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">search</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ Key, _Value }) -> Key </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "id"</span><span style="color:#D73A49;--shiki-dark:#F97583"> end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  [</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"{</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">id</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">:1,</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">title</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">post 1</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">content</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">blah</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">}"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">].</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">all</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(SessionID, Env, Input) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mod_esi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">deliver</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(SessionID, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Content-Type:application/json</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\r\n\r\n</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mod_esi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">deliver</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(SessionID, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">do_all</span><span style="color:#24292E;--shiki-dark:#E1E4E8">()).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">do_all</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  [</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"[{</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">title</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">post 1</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">content</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">: </span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">blah</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\"</span><span style="color:#032F62;--shiki-dark:#9ECBFF">}]"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">].</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">create</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(SessionID, Env, Input) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mod_esi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">deliver</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(SessionID, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Content-Type:application/json</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\r\n\r\n</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mod_esi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">deliver</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(SessionID, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">do_create</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Input)).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">do_create</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Input) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  % here the Input variable will contain the POST request' body, which will most likely be a JSON, which we also will need to parse</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  [</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Status: 204 No Content"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">].</span></span>
<span class="line"></span></code></pre>
<p>As you can see, this is a pretty complex example, since the API of <code>httpd</code> module is rather low-level - we have to explicitly form a HTTP response and send it back to clients.
Although not impossible, it is just not so pleasant development experience as it could be. Read on to see how it could be significantly improved.</p>
<div class="content-read-marker" data-fraction="50"></div>
<h3 id="mnesia">Mnesia</h3>
<p>Erlang is bundled with a distributed real-time database called Mnesia!</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">module</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">visit_tracker</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  init</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  create_schema</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  create_account</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  find_account_by_email</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">record</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">visit</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, { site_id, ip, browser, location }).</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">record</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">site</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, { id, account_id, name, visits }).</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">record</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">account</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, { id, email, sites }).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">init</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">create_schema</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([</span><span style="color:#6F42C1;--shiki-dark:#B392F0">node</span><span style="color:#24292E;--shiki-dark:#E1E4E8">()]),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">start</span><span style="color:#24292E;--shiki-dark:#E1E4E8">().</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">create_schema</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">create_table</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">visits</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [ { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">attributes</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">record_info</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">fields</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">visit</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) }, { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">record_name</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">visit</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> } ]),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">create_table</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">sites</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [ { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">type</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">bag</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">attributes</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">record_info</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">fields</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">site</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) }, { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">record_name</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">site</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> } ]),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">create_table</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">accounts</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [ { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">type</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">bag</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">attributes</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">record_info</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">fields</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">account</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) }, { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">record_name</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">account</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> } ]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">%% temporarily forcing to put ID by hand</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">create_account</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Id, Email) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Txn </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    %% record creation syntax is similar to dictionary / map creation syntax: `#record_name{ key = Value }`</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">write</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">accounts</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">account</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ id </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Id, email </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Email, sites </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [] }, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">write</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">transaction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Txn).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">create_site</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Account, Id, Name) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  AccId </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Account</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">account</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.id,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Txn </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    [ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">_</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">read</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">accounts</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, AccId),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    %% mnesia:write(Account),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">write</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">sites</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">site</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ account_id </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> AccId, id </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Id, name </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Name, visits </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [] }, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">write</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">transaction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Txn).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">create_visit</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Site, Ip) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  create_visit</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Site, Ip, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">unknown</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">unknown</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">create_visit</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Site, Ip, Browser) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  create_visit</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Site, Ip, Browser, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">unknown</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">create_visit</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Site, Ip, Browser, Location) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  %% retrieving ID field from the Site parameter</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  SiteId </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Site</span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">site</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.id,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Txn </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    [ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">_</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">read</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">sites</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, SiteId),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    %% since table name is different to record name, we have to pass table name as the first argument</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">transaction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Txn).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">find_account_by_email</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Email) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Txn </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    %% select semantics:</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    %%</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    %%   mnesia:select(Table_name, [ Query, Conditions, ResultMapping ])</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    %%</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    %% here,</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    %%  * Query defines the generic pattern to match agains</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    %%  * Conditions or Guard is a list of tuples defining the clauses: { operator, field, value }: { '>', 'id', 10 }</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    %%  * ResultMapping is what will be returned; you can use the pattern matching from the Query param here</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    %%</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    %% map / dictionary creation: #{ key => value }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    [ Acc ] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">select</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">accounts</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [ { </span><span style="color:#D73A49;--shiki-dark:#F97583">#</span><span style="color:#6F42C1;--shiki-dark:#B392F0">account</span><span style="color:#24292E;--shiki-dark:#E1E4E8">{ id</span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF">'$1'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, email</span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8">Email, sites</span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF">'$2'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, [], [ #{ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">id</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> '$1'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">email</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Email, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">sites</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> '$2'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> } ] } ]),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    Acc</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mnesia</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">transaction</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Txn).</span></span>
<span class="line"></span></code></pre>
<h2 id="ecosystem">Ecosystem</h2>
<p>Using <a href="https://hex.pm/">Rebar 3</a> (or <code>Hex</code> for Elixir) is relatively easy. Yet it opens access to thousands of packages available out there.</p>
<h3 id="creating-a-project">Creating a project</h3>
<p>To create a project with rebar3 support, you can now use <code>rebar3 new &#x3C;template> &#x3C;app-name></code>. For just an application, you can use <code>app</code> template name.
For libraries - use <code>lib</code>. Simple!</p>
<p>To add a dependency, edit the <code>rebar.config</code> file in the application directory and change the <code>deps</code> dictionary:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span><span style="color:#005CC5;--shiki-dark:#79B8FF">deps</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  {</span><span style="color:#005CC5;--shiki-dark:#79B8FF">epsql</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">~></span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 4.6.0"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">} </span><span style="color:#6A737D;--shiki-dark:#6A737D">% PostgreSQL package</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">]}.</span></span>
<span class="line"></span></code></pre>
<p>Then, since a single project can have multiple applications, one needs to add the dependency to each application which requires that dependency. This
is done in the <code>*.app.src</code> file in the <em>application</em> root directory (for instance, <code>myapp/appname/appname.app.src</code>):</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span><span style="color:#005CC5;--shiki-dark:#79B8FF">application</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">appname</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8"> [{</span><span style="color:#005CC5;--shiki-dark:#79B8FF">description</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">""</span><span style="color:#24292E;--shiki-dark:#E1E4E8">},</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  {</span><span style="color:#005CC5;--shiki-dark:#79B8FF">registered</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, []},</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  {</span><span style="color:#005CC5;--shiki-dark:#79B8FF">modules</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, []},</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  {</span><span style="color:#005CC5;--shiki-dark:#79B8FF">applications</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">kernel</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">                  stdlib</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">                  epsql</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]},</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  {</span><span style="color:#005CC5;--shiki-dark:#79B8FF">mod</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, {</span><span style="color:#005CC5;--shiki-dark:#79B8FF">appname_app</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, []}},</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  {</span><span style="color:#005CC5;--shiki-dark:#79B8FF">env</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, []}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8"> ]}.</span></span>
<span class="line"></span></code></pre>
<p>Building the project with dependencies is then done using the <code>rebar3 compile</code> command from the <em>project</em> root directory (following the example above, <code>myapp/</code>).</p>
<p>To run an application, use the <code>rebar3 shell --apps &#x3C;comma-separated-app-names></code> from the <em>project</em> root directory (e.g. <code>rebar3 shell --apps appname</code>).</p>
<h3 id="postgresql">PostgreSQL</h3>
<p>Working with PostgreSQL in Erlang is possible through one of many libraries available in <a href="https://hex.pm/packages">rebar3 repository</a>.
In this blog I will use <a href="https://github.com/epgsql/epgsql"><code>epsql</code></a> library.</p>
<p>For the most part, when working with the database, you only need a handful of features from the database library:</p>
<ul>
<li>connecting to the database with specific parameters (connection pool size, security options, timeouts, etc.)</li>
<li>executing prepared statements (allowing the DB communication layer - the library - to safely inject query parameters, preventing the SQL injection)</li>
<li>support for <code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code> and <code>DELETE</code> statements (with very few exceptions, these form 95% of all the use cases, in my experience)</li>
<li>retrieve query results (as list of dictionaries of sorts)</li>
</ul>
<div class="content-read-marker" data-fraction="75"></div>
<p>epsql library provides all of these with the following functions:</p>
<ul>
<li><code>epgsql:connect/1</code> (and its variations) in combination with <code>epgsql:close/1</code> to close the connection, if ever needed; <code>epgsql:connect/1</code> takes a dictionary of options, including
<ul>
<li><code>host</code></li>
<li><code>username</code> and <code>password</code>; optionally - <code>ssl</code> and <code>ssl_opts</code> for secure connections</li>
<li><code>database</code></li>
<li><code>timeout</code> - for limiting the connection time</li>
</ul>
</li>
<li><code>epgsql:squery/2</code> and <code>epgsql:equery/3</code> to query the database
<ul>
<li><code>epgsql:squery/2</code> will execute a simple query (takes connection and a query string as parameters, returns a tuple of status - <code>ok</code> or <code>error</code>, list of columns and list of rows)</li>
<li><code>epgsql:equery/3</code> will create an unnamed prepared statement (yes, you can have named prepared statements for future reuse), safely inject the query parameters (specified as <code>$1</code>, <code>$2</code>, <code>$3</code> and so on in query string, the second argument) passed as the third argument (a list of parameters) and execute the statement on a database connection (passed as the first argument)</li>
</ul>
</li>
</ul>
<p>Here are few simple examples of the above functions:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">connect_to_blog_db</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">ok</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, C } </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> epsql</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">connect</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(#{ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">host</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "localhost"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">username</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "root"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">password</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "****"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">database</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "blog"</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  C.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">create_blog</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Title, Content) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  C </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> connect_to_blog_db</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">ok</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Count } </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> epsql</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">equery</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(C, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"INSERT INTO posts (title, content) VALUES ($1, $2)"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [ Title, Content ]),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Count </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">get_blogs</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  C </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> connect_to_blog_db</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">ok</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Columns, Rows } </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> epsql</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">squery</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(C, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"SELECT title, content FROM posts"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Rows.</span></span>
<span class="line"></span></code></pre>
<h3 id="mochi-http-server">Mochi HTTP server</h3>
<p>As shown above, the default HTTP server bundled with Erlang standard library (OTP) is rather low-level.
There are few options in rebar3 package repository which significantly improve the situation. One of them is <a href="https://github.com/mochi/mochiweb/"><code>mochiweb</code></a>.</p>
<p>The web server with Mochi could look like this (slightly more complex than the one described above with <code>httpd</code>):</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">module</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">http_sample</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([ </span><span style="color:#6F42C1;--shiki-dark:#B392F0">dispatch</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">loop</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">start</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">stop</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">define</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">HTTP_OPTS</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  [ { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">loop</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, {</span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#6F42C1;--shiki-dark:#B392F0">MODULE</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">dispatch</span><span style="color:#24292E;--shiki-dark:#E1E4E8">} },</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">port</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">4000</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">name</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">http_4000</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> } ]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">start</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">ok</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Http } </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> mochiweb_http</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">start</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#6F42C1;--shiki-dark:#B392F0">HTTP_OPTS</span><span style="color:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Pid </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> spawn_link</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> () </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> loop</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Http) </span><span style="color:#D73A49;--shiki-dark:#F97583">end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  register</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">http_sample</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Pid),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  ok</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">stop</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  http_sample</span><span style="color:#D73A49;--shiki-dark:#F97583"> !</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> stop</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  ok</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">dispatch</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Req) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  case</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> mochiweb_request</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">method</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Req) </span><span style="color:#D73A49;--shiki-dark:#F97583">of</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    'GET'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> -> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">get_resource</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Req);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    'PUT'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> -> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">put_resource</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Req);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    _</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> -> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">method_not_allowed</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Req)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">get_resource</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Req) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Path </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> mochiweb_request</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">path</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Req),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  % note: io:format(FmtString, Params) would print to STDOUT</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  % whereas io_lib:format(FmtString, Params) will return a formatted string</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Body </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> io_lib</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">format</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Hello, Resource '</span><span style="color:#005CC5;--shiki-dark:#79B8FF">~s</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\r\n</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [ Path ]),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Headers </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [{ </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Content-Type"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"text/plain"</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }],</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mochiweb_request</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">respond</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">200</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Headers, Body }, Req),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  ok</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">put_resource</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Req) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  ContentType </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> mochiweb_request</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get_header_value</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Content-Type"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Req),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  ReqBody </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> mochiweb_request</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">recv_body</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Req),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mochiweb_request</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">respond</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">201</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [], </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"201 Created</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\r\n</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }, Req),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  ok</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">method_not_allowed</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Req) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Path </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> mochiweb_request</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">path</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Req),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Method </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> mochiweb_request</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">method</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Req),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Body </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> io_lib</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">format</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Method </span><span style="color:#005CC5;--shiki-dark:#79B8FF">~s</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> on path </span><span style="color:#005CC5;--shiki-dark:#79B8FF">~s</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> is not supported"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [ Method, Path ]),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  mochiweb_request</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">respond</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">405</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [], Body }, Req),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">  ok</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">loop</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Http) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  receive</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    stop</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> -></span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">      ok</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> mochiweb_http</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">stop</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Http),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">      exit</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">normal</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    _</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> -> </span><span style="color:#005CC5;--shiki-dark:#79B8FF">ignore</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  (</span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#6F42C1;--shiki-dark:#B392F0">MODULE</span><span style="color:#24292E;--shiki-dark:#E1E4E8">):</span><span style="color:#6F42C1;--shiki-dark:#B392F0">loop</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Http).</span></span>
<span class="line"></span></code></pre>
<p>For this code to run, you should do few little extra steps. First, creating the new application with <code>rebar3</code> - I prefer <code>escript</code> template for something this simple.</p>
<p>Then, add a new dependency to the <code>rebar.config</code> file:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span><span style="color:#005CC5;--shiki-dark:#79B8FF">erl_opts</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">debug_info</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]}.</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span><span style="color:#005CC5;--shiki-dark:#79B8FF">deps</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  {</span><span style="color:#005CC5;--shiki-dark:#79B8FF">mochiweb</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"2.22.0"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">} </span><span style="color:#6A737D;--shiki-dark:#6A737D">% &#x3C;---- here</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">]}.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span><span style="color:#005CC5;--shiki-dark:#79B8FF">shell</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">  % {config, "config/sys.config"},</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    {</span><span style="color:#005CC5;--shiki-dark:#79B8FF">apps</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">http_sample</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">]}.</span></span>
<span class="line"></span></code></pre>
<p>Then, put the code from above under <code>src/http_server.erl</code> file.</p>
<p>Finally, run the interactive shell in the context of the application: <code>rebar3 shell</code> and start server by calling <code>http_server:start().</code>.</p>
<p>Alternatively, you can compile the program to a binary file using <code>rebar3 compile</code> and then run the program using <code>erl</code> command:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">erl</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> -pa</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> _build/default/lib/http_sample3/ebin/</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> -pa</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> _build/default/lib/mochiweb/ebin/</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> -noshell</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> -s</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> http_sample3</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> main</span></span>
<span class="line"></span></code></pre>
<p>This, however, will immediately stop the execution of a program once the <code>http_sample3:main/0</code> finishes, so you might want to change the source a bit:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Args) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    io</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">format</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Hello, server!</span><span style="color:#005CC5;--shiki-dark:#79B8FF">~n</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, []),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    http_server</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">start</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    receive</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">        stop</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> -> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">http_server</span><span style="color:#24292E;--shiki-dark:#E1E4E8">:</span><span style="color:#6F42C1;--shiki-dark:#B392F0">stop</span><span style="color:#24292E;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    done</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span></code></pre>
<p>This way, the <code>http_sample3:main/1</code> will be called and will wait for the <code>stop</code> signal to be sent to the process.
Or until the main <code>erl</code> process is terminated.</p>
<p>Finally you should be able to communicate with this rather simple server by using <code>curl</code>, for example:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">curl</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> http://localhost:4000/my/resource</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> -X</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> PUT</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> -d</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> '{ "name": "message", "value": "my message" }'</span></span>
<span class="line"></span></code></pre>
<h2 id="summary">Summary</h2>
<p>This blog was supposed to show Erlang from a slighly different perspective, as opposed to how it was presented to me
in uni. I guess you could treat this as a ‚ÄúPractical Erlang‚Äù blog.</p>
<p>This post was supposed to be released in mid-2020, but it took me quite a while to polish it. In the next blog I will
build this on to provide a much more exciting application sample with Erlang.</p>
<div class="content-read-marker" data-fraction="100"></div> </div>  </article><article> <h1> <a href="/2020/08/04/2020-08-04-vim-keystrokes-cheatsheet.html">Vim keystrokes cheatsheet</a> </h1> <time datetime="2020-08-04T01:04:24.000Z"> Aug 4, 2020 </time> <div class="content"> <p>The time has come for me to list few of the commands and keystrokes that I use (and the ones that I don‚Äôt but would like to start) in Vim.</p>
<p>I am actually running a Vim plugin for Visual Studio Code (this and the previous blogs are actually written with this plugin ON) at this very moment.</p>
<p>Bear üêª in mind: this blog is aboout <em>keystrokes</em> only, it is not about plugins or configuration I use - I shall cover that one day.</p>
<h2 id="things-i-know-by-heart">Things I know by heart</h2>
<ul>
<li><kbd>h</kbd>, <kbd>j</kbd>, <kbd>k</kbd>, <kbd>l</kbd> for slow but precise character-wise movement</li>
<li><kbd>w</kbd>, <kbd>b</kbd> for faster forward (and, correspondingly) backward word-by-word movement</li>
<li><kbd>$</kbd> and <kbd>^</kbd> to go to the last and first word character of the line</li>
<li><kbd>gg</kbd> and <kbd>G</kbd> to go to the beginning and the end of the file</li>
<li><kbd>O</kbd> (capital <code>o</code>) to create a blank line and go to INSERT mode above and below (lower-case <code>o</code>) the cursor</li>
<li><kbd>f</kbd>, <kbd>F</kbd> and <kbd>t</kbd> and <kbd>T</kbd> for single character lookup within the current line</li>
<li><kbd>/</kbd> and <kbd>?</kbd> to search forwards and backwards</li>
<li><kbd>c</kbd> (followed by the object) to change the <em>object</em>; this expands to the following few commands:
<ul>
<li><kbd>cw</kbd> to change the current word under cursor</li>
<li><kbd>cit</kbd> to change the text within the current XML tag</li>
<li><kbd>ca‚Äô</kbd> to change the text surrounded by single quote</li>
<li><kbd>ci&#x3C;</kbd> to change the text surrounded with <code>&#x26;lt;</code> and <code>&#x26;gt;</code></li>
<li><kbd>ci{symbol}</kbd> to change the text surrounded by <em>symbol</em>, which could be <code>'</code>, <code>"</code>, <code>&#x26;#96;</code>; you can also use <kbd>b(</kbd> for block of text, surrounded by braces, <kbd>B{</kbd> for block of text surrounded by curly braces or <kbd>p</kbd> for paragraph, all instead of <em>symbol</em></li>
</ul>
</li>
<li><kbd>v</kbd> to enter the VISUAL mode, followed by the command:
<ul>
<li><kbd>v{select}c</kbd> immediately change the selection</li>
<li><kbd>v{select}d</kbd> cut the selected text</li>
</ul>
</li>
<li><kbd>y</kbd> and <kbd>p</kbd> copy and paste the selected text (lower-case <code>p</code> pastes above the current line, capital-case <code>P</code> pastes below; capital-case <code>Y</code> copies the entire line, so the duplicate line command in Vim is <kbd>Y, P</kbd>)</li>
<li><kbd>{number}{command}</kbd> repeat the <em>command</em> <em>number</em> times</li>
<li><kbd>.</kbd> (the period or dot symbol) repeats the last command</li>
<li><kbd>x</kbd> to remove the character under cursor</li>
<li><kbd>r{char}</kbd> to replace the character under cursor with <em>char</em></li>
<li><kbd>A</kbd> to go to the end of the line and enter INSERT mode (‚Äúappend‚Äù)</li>
<li><kbd>u</kbd> and <kbd>Ctrl+r</kbd> to undo and redo actions</li>
<li><kbd>></kbd> and <kbd>&#x3C;</kbd> adds or removes the indentation</li>
</ul>
<h2 id="things-that-i-am-still-getting-used-to">Things that I am still getting used to</h2>
<ul>
<li><kbd>{number}{motion}</kbd> instead of <kbd>h</kbd>, <kbd>j</kbd>, <kbd>k</kbd>, <kbd>l</kbd></li>
<li><kbd>a</kbd> instead of <kbd>i</kbd> to enter INSERT mode <em>after</em> the cursor (as opposed to <kbd>i</kbd> which enters INSERT mode <em>before</em> the cursor)</li>
<li><kbd>H</kbd>, <kbd>M</kbd> and <kbd>L</kbd> to go to the top, middle and the bottom of the screen (High, Mid and Low)</li>
<li><kbd>*</kbd> and <kbd>#</kbd> to search for the word under cursor forwards and backwards</li>
<li><kbd>{count}/{query}‚èé</kbd> to go to the <em>count</em>-th occurrence of <em>query</em>; it is same as searching with <kbd>/</kbd> and then hitting <kbd>n</kbd> <em>count</em> times</li>
<li><kbd>gd</kbd> navigates to a definition of an entity under the cursor</li>
<li><kbd>gf</kbd> navigates to the path under cursor</li>
<li><kbd>%</kbd> moves the cursor to the matching brace, bracket or curly brace</li>
<li><kbd>g~</kbd> toggle the case</li>
<li><kbd>=</kbd> format the selection</li>
<li><kbd>gU</kbd> makes the selection uppercase</li>
</ul> </div>  </article><article> <h1> <a href="/2020/08/02/2020-08-02-gantt-chart-part2.html">Gantt chart with D3. Part 2</a> </h1> <time datetime="2020-08-02T05:04:24.000Z"> Aug 2, 2020 </time> <div class="content"> <h2 id="contents">Contents</h2>
<ul>
<li><a href="/2017/04/09/gantt-chart-with-d3.html">Gantt chart with D3</a></li>
<li><a href="/2020/08/02/gantt-chart-part2.html"><strong>Gantt chart with D3. Part 2 (you are here)</strong></a></li>
<li><a href="/2021/03/04/gantt-chart-part3.html">Gantt chart with Canvas</a></li>
<li><a href="/2024/06/26/gantt-chart-part4.html">Gantt chart with CSS Grids</a></li>
</ul>
<p>In the original blog I claimed to implement something like this:</p>
<img src="/images/gantt_chart_with_d3/gantt-sample_optimized.webp" loading="lazy" alt="">
<p>Yet I ended up implementing something more like this:</p>
<img src="/images/gantt_chart_with_d3/d3-gantt-chart_optimized.webp" loading="lazy" alt="">
<p>Does not look quite same, right? It also does not work quite same and lacks few quite important features too.</p>
<p>Don‚Äôt get me wrong, the original implementation did serve project needs, but it was not something anybody could simply use in their project management software and expect customers to love it.</p>
<p>Hence I came up with these complaints about the implementation:</p>
<img src="/images/gantt_chart_with_d3_part2/complaints-min.webp" loading="lazy" alt="">
<p>Namely, there are three main issues that I see:</p>
<ol>
<li>there is a place for mistakes: milestones are allowed to depend on later milestones or simultaneously going ones</li>
<li>there is no clear distinction between the dates each specific milestone starts or ends</li>
<li>if the milestones overlap with current timeframe, current day is not highlighted on the chart (and that often is useful)</li>
</ol>
<p>Apart from that, there are few technical challenges preventing his whole thing from becoming a real application component:</p>
<ul>
<li>dependency lines look ugly with those sharp corners</li>
<li>the implementation is not based on any framework neither does it declare its dependencies (like D3 or MomentJS)</li>
</ul>
<p>Now I want to revise the original implementation and make it a bit more usable, just like this:</p>
<img src="/images/gantt_chart_with_d3_part2/chart_with_current_date-min.webp" loading="lazy" alt="">
<!--more-->
<p>The plan for this blog is:</p>
<ul>
<li>Technical improvements
<ul>
<li>revise the implementation into a proper Node package</li>
<li>optimize for bundle size</li>
</ul>
</li>
<li>Feature improvements
<ul>
<li>render milestone conflicts in different style</li>
<li>draw days on a background</li>
<li>draw current date, if applicable</li>
<li>make lines more like curves</li>
</ul>
</li>
</ul>
<h2 id="extracting-into-a-package">Extracting into a package</h2>
<p>Well this one is pretty easy - you just do <code>npm init -y</code>, add dependencies with <code>npm install --save moment d3</code> and require them in your file.</p>
<p>I went a tiny bit further and also changed few minor syntactic inconsistencies to follow with the more modern ES syntax:</p>
<ul>
<li>using <code>import</code> instead of <code>require()</code></li>
<li>preferring <code>const</code> over <code>let</code> and <code>var</code></li>
<li>replacing the <code>Object.assign</code> with spread operator</li>
<li>passing in the default values to the function params instead of constantly checking for <code>null</code> and <code>undefined</code></li>
</ul>
<h2 id="bundling">Bundling</h2>
<p>Although the package declares the dependencies, it does not really use them. Well, it could, but only in case it would be used in the system which defined <code>require()</code> function.</p>
<p>D3 itself is a heavy package. Same applies to moment.js. If you bundle the library with anything (I have used Parcel to do it quickly), you‚Äôll see that this relatively small library builds into a 500kB bundle.</p>
<img src="/images/gantt_chart_with_d3_part2/bundle_size1-min.webp" loading="lazy" alt="">
<p>I think that is quite ridiculous, so here are few considerations:</p>
<ul>
<li>replace momentjs with something more lightweight</li>
<li>import only specific packages from D3 instead of the whole thing</li>
</ul>
<p>Let us actually start with D3.</p>
<div class="content-read-marker" data-fraction="25"></div>
<p>The library currently operates on few features from D3:</p>
<ul>
<li>selecting DOM nodes</li>
<li>drawing
<ul>
<li>axes</li>
<li>lines (actually, multilines or paths)</li>
<li>rounded rectangles</li>
<li>text</li>
</ul>
</li>
<li>scaling values (across timeframe)</li>
</ul>
<p>These features actually come in just few D3 packages:</p>
<ul>
<li><code>d3-axis</code></li>
<li><code>d3-scale</code></li>
<li><code>d3-select</code></li>
</ul>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { axisBottom } </span><span style="color:#D73A49;--shiki-dark:#F97583">from</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'd3-axis'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { scaleTime } </span><span style="color:#D73A49;--shiki-dark:#F97583">from</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'd3-scale'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { select } </span><span style="color:#D73A49;--shiki-dark:#F97583">from</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'd3-selection'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span></code></pre>
<p>By just using these three imports (and using these functions instead of their <code>d3.</code> counterparts), we can half the size of the bundle:</p>
<img src="/images/gantt_chart_with_d3_part2/bundle_size2-min.webp" loading="lazy" alt="">
<p>Some of the features (like drawing text) are actually just methods on the <code>selection</code>, provided by <code>d3-select</code> or the <code>path</code> object, provided by <code>d3-path</code>.</p>
<h2 id="optimizing-even-more">Optimizing even more</h2>
<p>Currently, <code>moment.js</code> is used for few purposes:</p>
<ul>
<li>parse the dates</li>
<li>sort the milestones by dates</li>
<li>calculate the length of each milestone based on its start and end dates or either of those and a duration</li>
</ul>
<p>Moment is quite a heavy thing. For now, let‚Äôs ignore date parsing and just replace the initial data with the <code>Date</code> object from the native APIs:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">moment</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(date); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// => date</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">date.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">toDate</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// => date</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">date.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">subtract</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(x); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// => date - x</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">date.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(x); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// => date + x</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">moment</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(string); </span><span style="color:#6A737D;--shiki-dark:#6A737D">// => new Date(string)</span></span>
<span class="line"></span></code></pre>
<p>By doing so, we have cut another 60 kB off the bundle!</p>
<img src="/images/gantt_chart_with_d3_part2/bundle_size3-min.webp" loading="lazy" alt="">
<p>Before we do hardcore optimizations (getting rid of D3 itself), let us do a bit of feature work first.</p>
<h2 id="detecting-conflicts">Detecting conflicts</h2>
<p>To figure out if a given milestone conflicts with any other milestones, we have to traverse its dependencies and check if any of those start on or after the current milestone‚Äôs start date.</p>
<p>Luckily the internal representation of a milestone already contains that data, so all we have to do is dependencies traversal:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> detectConflicts</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#E36209;--shiki-dark:#FFAB70"> data</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> dataCache</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> createDataCacheById</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(data);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> data.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">map</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">milestone</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> errorousDependencies</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> milestone.dependsOn.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">filter</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">dependencyId</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> dataCache[dependencyId].startDate </span><span style="color:#D73A49;--shiki-dark:#F97583">>=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> milestone.startDate);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    milestone.errors </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (milestone.errors </span><span style="color:#D73A49;--shiki-dark:#F97583">||</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> []).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">concat</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(errorousDependencies.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">map</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#E36209;--shiki-dark:#FFAB70">errorId</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#032F62;--shiki-dark:#9ECBFF"> `Dependency ${</span><span style="color:#24292E;--shiki-dark:#E1E4E8">errorId</span><span style="color:#032F62;--shiki-dark:#9ECBFF">} must end before this milestone`</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> milestone;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">};</span></span>
<span class="line"></span></code></pre>
<p>Then we can render those milestones with errors and their connectivity lines with different styles:</p>
<div class="content-read-marker" data-fraction="50"></div>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">let</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> stroke </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> color;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (d.errors.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">length</span><span style="color:#D73A49;--shiki-dark:#F97583"> ></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  strokeDash </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> '3'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  stroke </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> '#d33'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">linesContainer</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">selectAll</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'polyline'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">data</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(polylineData)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">enter</span><span style="color:#24292E;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">append</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'polyline'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">style</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'fill'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'none'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">style</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'stroke'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">d</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> d.stroke)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">style</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'stroke-dasharray'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">d</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> d.strokeDash)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'points'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">d</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> d.points);</span></span>
<span class="line"></span></code></pre>
<img src="/images/gantt_chart_with_d3_part2/chart_with_errors1-min.webp" loading="lazy" alt="">
<p>For milestones themselves we can add a <code>pattern</code> and make it striped:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// error style</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">svg.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">append</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'pattern'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'id'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'error-fill'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'patternUnits'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'userSpaceOnUse'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'width'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'4'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'height'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'4'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">append</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'path'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'d'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">style</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'stroke'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'#d33'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">style</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'stroke-width'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'1'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">bars</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">append</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'rect'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'rx'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, elementHeight </span><span style="color:#D73A49;--shiki-dark:#F97583">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'ry'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, elementHeight </span><span style="color:#D73A49;--shiki-dark:#F97583">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'x'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">d</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> d.x)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'y'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">d</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> d.y)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'width'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">d</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> d.width)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'height'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">d</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> d.height)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">style</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'fill'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">d</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> d.errors.</span><span style="color:#005CC5;--shiki-dark:#79B8FF">length</span><span style="color:#D73A49;--shiki-dark:#F97583"> ></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="color:#D73A49;--shiki-dark:#F97583"> ?</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'url(#error-fill)'</span><span style="color:#D73A49;--shiki-dark:#F97583"> :</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> '#ddd'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">style</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'stroke'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'black'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span></code></pre>
<img src="/images/gantt_chart_with_d3_part2/chart_with_errors2-min.webp" loading="lazy" alt="">
<h2 id="displaying-days-on-a-background">Displaying days on a background</h2>
<p>We can leverage the features of a time scale that D3 provides us with to render the days on a background.</p>
<p>The scale, however, is not that easy - it operates on dates, so the width of each day is something we will have to calculate ourselves.
It also might have extra ticks in between days (for the month change, for instance) - and that is something I am yet to overcome.</p>
<p>Long story short, before rendering the milestones and their connectivity lines, we can add a bunch of semi-transparent rectangles:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> grid</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> g1.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">append</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'g'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">call</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(xAxis);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">grid</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">append</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'g'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">selectAll</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'rect'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">data</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(xScale.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">ticks</span><span style="color:#24292E;--shiki-dark:#E1E4E8">())</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">enter</span><span style="color:#24292E;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">append</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'rect'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'x'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, (</span><span style="color:#E36209;--shiki-dark:#FFAB70">d</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">i</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> xScale</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(d))</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'y'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'height'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, svgHeight)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'width'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, (</span><span style="color:#E36209;--shiki-dark:#FFAB70">d</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">i</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> svgWidth </span><span style="color:#D73A49;--shiki-dark:#F97583">/</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> xScale.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">ticks</span><span style="color:#24292E;--shiki-dark:#E1E4E8">().</span><span style="color:#005CC5;--shiki-dark:#79B8FF">length</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">style</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'fill'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'#dedede30'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span></code></pre>
<p>As you can see, the width of a rectangle is being calculated based on the total width of an <code>svg</code> container and the amount of scale‚Äôs <code>ticks</code>.</p>
<img src="/images/gantt_chart_with_d3_part2/chart_with_days1-min.webp" loading="lazy" alt="">
<div class="content-read-marker" data-fraction="75"></div>
<p>One little change to this implementation that I would like to see is alteration in rectangles‚Äô colors:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">grid</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">append</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'g'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">selectAll</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'rect'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">data</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(xScale.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">ticks</span><span style="color:#24292E;--shiki-dark:#E1E4E8">())</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">enter</span><span style="color:#24292E;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">append</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'rect'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'x'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, (</span><span style="color:#E36209;--shiki-dark:#FFAB70">d</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">i</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#6F42C1;--shiki-dark:#B392F0"> xScale</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(d))</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'y'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'height'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, svgHeight)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'width'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, (</span><span style="color:#E36209;--shiki-dark:#FFAB70">d</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">i</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> svgWidth </span><span style="color:#D73A49;--shiki-dark:#F97583">/</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> xScale.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">ticks</span><span style="color:#24292E;--shiki-dark:#E1E4E8">().</span><span style="color:#005CC5;--shiki-dark:#79B8FF">length</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">style</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'fill'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, (</span><span style="color:#E36209;--shiki-dark:#FFAB70">d</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#E36209;--shiki-dark:#FFAB70">i</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> i </span><span style="color:#D73A49;--shiki-dark:#F97583">%</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="color:#D73A49;--shiki-dark:#F97583"> ?</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> '#dedede30'</span><span style="color:#D73A49;--shiki-dark:#F97583"> :</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> '#dedede00'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span></code></pre>
<img src="/images/gantt_chart_with_d3_part2/chart_with_days2-min.webp" loading="lazy" alt="">
<h2 id="highlighting-the-current-date">Highlighting the current date</h2>
<p>Right before we draw the rectangles and even the axis itself (again, to prevent the overlapping), we can draw a line showing the current date, if it fits into the range of the chart. For this we can also leverage the properties of the <code>xScale</code>, this time <code>.range()</code>, which returns a two-element array, denoting the beginning and end values of the scale. Of course, we will have to convert the current date to the value on that scale too:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">const</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> nowOnScale</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> xScale</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Date.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">now</span><span style="color:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (nowOnScale </span><span style="color:#D73A49;--shiki-dark:#F97583">>=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> xScale.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">range</span><span style="color:#24292E;--shiki-dark:#E1E4E8">()[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> nowOnScale </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> xScale.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">range</span><span style="color:#24292E;--shiki-dark:#E1E4E8">()[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  grid</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">append</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'line'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'x1'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, nowOnScale)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'y1'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'x2'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, nowOnScale)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">attr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'y2'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, svgHeight)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">style</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'stroke'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'rgb(232, 102, 102)'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    .</span><span style="color:#6F42C1;--shiki-dark:#B392F0">style</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'stroke-width'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<img src="/images/gantt_chart_with_d3_part2/chart_with_current_date-min.webp" loading="lazy" alt="">
<h2 id="to-be-continued">To be continued</h2>
<p>The source code of this implementation could be found on <a href="https://github.com/shybovycha/gantt-chart">Github</a>.</p>
<p>I think that is enough for now, but it is not the end! There‚Äôs still some work to be done in removing the D3 from this setup completely,
which is actually done in <a href="/2021/03/04/gantt-chart-part3.html">Gantt chart: part 3</a> blog.</p>
<div class="content-read-marker" data-fraction="100"></div> </div>  </article><article> <h1> <a href="/2020/01/10/2020-01-10-erlang-in-5-minutes.html">Erlang in 5 minutes</a> </h1> <time datetime="2020-01-10T04:24:24.000Z"> Jan 10, 2020 </time> <div class="content"> <h2 id="x--erlang-y--5-ioformatlearn-s-in-s-minutes--x-y">X = erlang, Y = 5, io:format(‚ÄúLearn ~s in ~s minutes‚Äù, [ X, Y ]).</h2>
<p>Welcome to a 5-minute Erlang introduction!</p>
<p>First things first:</p>
<ul>
<li>Erlang is a functional programming language</li>
<li><code>erl</code> is the REPL shell</li>
<li><kbd>Ctrl + G</kbd> and then <kbd>q</kbd> <strong>or</strong> <code>q().</code> to exit the shell</li>
<li><code>c(file_name).</code> to load the code from file</li>
</ul>
<p>Now, to the language constructs:</p>
<ul>
<li>every statement has to end with a dot (<code>.</code>) symbol</li>
<li>multiple statements are separated by comma (<code>,</code>) character</li>
<li>constants start with a <strong>C</strong>apital <strong>L</strong>etter</li>
<li><em>atoms</em> (yes, like in Ruby) start with <strong>l</strong>owercase <strong>l</strong>etter</li>
<li>atoms are allowed to contain spaces (sic!), but then they have to be quoted: <code>'atoms are awesome'</code></li>
<li>atoms can also have the at sign (<code>@</code>)</li>
<li>anonymous functions are defined as <code>fun() -> return_statement end.</code></li>
<li>last statement before <code>end</code> <strong>must not</strong> end with comma</li>
<li>function signature is <code>function_name/number_of_arguments</code>: <code>factorial/1</code>, <code>format/2</code></li>
<li>comments start with percent (<code>%</code>) symbol</li>
<li>lists are <code>[ TheOnlyElement ]</code> or <code>[ Head | TailElements ]</code>, where <code>TailElements</code> is also a list</li>
<li>pattern matching just works <code>[ Head1 | Head2 | Tails ] = [ 1, 2, 3, 4 ]</code></li>
<li>strings are just <code>"strings"</code></li>
<li>tuples are quirky <code>{ elt1, elt2 }</code></li>
<li>maps are even weirder <code>#{ key => value }</code></li>
<li>operators are almost fine:
<ul>
<li>comparison: <code>&#x3C;</code> (less than), <code>></code> (greater than), <code>>=</code> (greater than or equals to), <code>=&#x3C;</code> (equals to or less than), <code>==</code> (equals to), <code>/=</code> (not equals to), <code>=:=</code> (adds type checking on tops, JS equivalent of <code>===</code>)</li>
<li>assignment / pattern matching: <code>=</code></li>
<li>math: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>div</code>, <code>rem</code> (Pascal way)</li>
<li>typechecking: <code>is_atom/1</code>, <code>is_function/1</code>, <code>is_number/1</code>, <code>is_boolean/1</code>, <code>is_pid/1</code>, <code>is_list/1</code>, etc.</li>
</ul>
</li>
<li>list comprehentions are similar to lists: <code>[ N || N &#x3C;- [ 1, 2, 3, 4, 5 ], N rem 2 == 0 ].</code></li>
<li>files are modules, defined with few statements:
<ul>
<li><code>-module(module_name).</code></li>
<li><code>-export([ list_of_function_signatures ]).</code></li>
<li><code>-import(module_name, [ list_of_functions ]).</code></li>
</ul>
</li>
<li>calling module‚Äôs export be like <code>module_name:function_name(arguments).</code></li>
</ul>
<p>Quick recap:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="erlang"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">%%% module comment</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">module</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">erlang_example</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">% exporting the functions from the module</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">export</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([ </span><span style="color:#6F42C1;--shiki-dark:#B392F0">factorial</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">% importing the functions from the other module</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">-</span><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">my_other_module</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [ </span><span style="color:#6F42C1;--shiki-dark:#B392F0">new_factorial</span><span style="color:#24292E;--shiki-dark:#E1E4E8">/</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ]).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">% constants with pattern matching - will assign the value to non-defined constant on success</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">X </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 5</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">% redefinition is prohibited</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">X </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 10</span><span style="color:#24292E;--shiki-dark:#E1E4E8">. </span><span style="color:#6A737D;--shiki-dark:#6A737D">% exception</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">% functions can also be constants</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">PlusOne </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(X) -> X </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#D73A49;--shiki-dark:#F97583"> end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">% or, multiline</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">PlusTwo </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(X) -></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  X </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">% the standard way</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">bad_factorial</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(N) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  N </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> factorial</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(N </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">%% function documentation</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">% functions can have *guargs*, which are basically pattern matching</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">% also, function overloading is split with semicolon (;)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">factorial</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(N) </span><span style="color:#D73A49;--shiki-dark:#F97583">when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> N </span><span style="color:#D73A49;--shiki-dark:#F97583">=&#x3C;</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#D73A49;--shiki-dark:#F97583"> -></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">% last overload ends with dot (.)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">factorial</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(N) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> N </span><span style="color:#D73A49;--shiki-dark:#F97583">*</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> factorial</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(N </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">% some return types</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">string_fn</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "hello, world!"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">list_fn</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"elements could be of different types too"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">-</span><span style="color:#005CC5;--shiki-dark:#79B8FF">3.14</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">atom</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ].</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">function_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  fun</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(X) -> X </span><span style="color:#005CC5;--shiki-dark:#79B8FF">mod</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="color:#D73A49;--shiki-dark:#F97583"> end</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">dict_fn</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> #{ </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"key"</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#D73A49;--shiki-dark:#F97583"> -</span><span style="color:#005CC5;--shiki-dark:#79B8FF">3.14</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">tuple_fn</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="color:#005CC5;--shiki-dark:#79B8FF">elt1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">elt2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"elt 3"</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">%% note how overriden_function/1 has different definition than overriden_function/2</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">overriden_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(List) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  overriden_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(List, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">% the power of pattern matching!</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">overriden_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([ Head ], Acc) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Acc </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Head;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">overriden_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([ Head1 | Head2 ], Acc) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Acc </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Head1 </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Head2;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">overriden_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([ Head | Tail ], Acc) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  overriden_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Tail, Acc </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Head);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">overriden_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([], Acc) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Acc.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">complex_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(A, B) </span><span style="color:#D73A49;--shiki-dark:#F97583">when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> A </span><span style="color:#D73A49;--shiki-dark:#F97583">=&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> B </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> A;</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">complex_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(A, B) </span><span style="color:#D73A49;--shiki-dark:#F97583">when</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> A </span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> B </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> B.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">complex_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(A, B, C) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  X </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> complex_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(A, B),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  complex_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(X, C);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">complex_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(A, B, C, D) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  X </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> complex_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(A, B),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  Y </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> complex_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(C, D),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  complex_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(X, Y).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">fst</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ First, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">_</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> }) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> First.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">snd</span><span style="color:#24292E;--shiki-dark:#E1E4E8">({ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">_</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, Second }) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Second.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">evens</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(List) </span><span style="color:#D73A49;--shiki-dark:#F97583">-></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ X || X </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;-</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> List, X </span><span style="color:#D73A49;--shiki-dark:#F97583">rem</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="color:#D73A49;--shiki-dark:#F97583"> ==</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ].</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">keys</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(#{ Key </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Value, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">_</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> _</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> })</span></span>
<span class="line"></span></code></pre>
<p>There also are few good resources on this: [<a href="https://learnxinyminutes.com/docs/erlang/%5D(Learn">https://learnxinyminutes.com/docs/erlang/](Learn</a> X in Y minutes (where X = erlang)) and [<a href="http://erlang.org/doc/apps/inets/http_client.html%5D(Official">http://erlang.org/doc/apps/inets/http_client.html](Official</a> Erlang docs).</p> </div>  </article><article> <h1> <a href="/2020/01/10/2020-01-10-a-response-to-response-to-hello-world.html">A response to response to hello world</a> </h1> <time datetime="2020-01-10T04:10:24.000Z"> Jan 10, 2020 </time> <div class="content"> <p>Recently I‚Äôve received an email from StackOverflow newsletters with a link to a quite controversial (at first glance) blog, <a href="https://www.doxsey.net/blog/a-response-to-hello-world">A response to Hello World</a> by Caleb Doxsey. This blog is a response to another curious read, <a href="https://drewdevault.com/2020/01/04/Slow.html">Hello world</a> by Drew DeVault.</p>
<p>In the former article, author compared the performance of a tiny ‚ÄúHello, World‚Äù program in Assembly to the same program in Go.
He then tried to optimize the program in Go to run faster and towards the end of an article comes up with a program that is faster than its Assembly counterpart.</p>
<img alt="" data-src="/images/a-response-to-response-to-hello-world/hello-world-original-chart-min.webp">
<img alt="" data-src="/images/a-response-to-response-to-hello-world/hello-world-new-chart-min.webp">
<img alt="" data-src="/images/a-response-to-response-to-hello-world/hello-world-new-chart2-min.webp">
<p>And this totally makes sense, since if you give it a good read, you will notice that author did optimize the program in Go but did not do that for the Assembly program.</p>
<p>I have decided to burn few hours of my life and jump onto this topic, since, in my opinion, author did not do a fair comparison.</p>
<!--more-->
<p>The original code Caleb has used is (I have added the imports and package declaration required to run the program):</p>
<h3 id="go">Go</h3>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">package</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "</span><span style="color:#6F42C1;--shiki-dark:#B392F0">strconv</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "</span><span style="color:#6F42C1;--shiki-dark:#B392F0">os</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">func</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    n, _ </span><span style="color:#D73A49;--shiki-dark:#F97583">:=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> strconv.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Atoi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(os.Args[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    for</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> i </span><span style="color:#D73A49;--shiki-dark:#F97583">:=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; i </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> n; i</span><span style="color:#D73A49;--shiki-dark:#F97583">++</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        os.Stdout.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Write</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([]</span><span style="color:#D73A49;--shiki-dark:#F97583">byte</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"hello world</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\n</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">))</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="assembly">Assembly</h3>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="asm"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">_start:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsp</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> + </span><span style="color:#005CC5;--shiki-dark:#79B8FF">16</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> atoi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">helloloop:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, len</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, msg</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    syscall</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    dec</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    cmp</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jg</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .helloloop</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">60</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    syscall</span></span>
<span class="line"></span></code></pre>
<h3 id="optimized-go">Optimized Go</h3>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">package</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "</span><span style="color:#6F42C1;--shiki-dark:#B392F0">strconv</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "</span><span style="color:#6F42C1;--shiki-dark:#B392F0">os</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">import</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "</span><span style="color:#6F42C1;--shiki-dark:#B392F0">bufio</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">func</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    n, _ </span><span style="color:#D73A49;--shiki-dark:#F97583">:=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> strconv.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Atoi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(os.Args[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">])</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    w </span><span style="color:#D73A49;--shiki-dark:#F97583">:=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> bufio.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">NewWriter</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(os.Stdout)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    defer</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> w.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Flush</span><span style="color:#24292E;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    for</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> i </span><span style="color:#D73A49;--shiki-dark:#F97583">:=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; i </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> n; i</span><span style="color:#D73A49;--shiki-dark:#F97583">++</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        w.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Write</span><span style="color:#24292E;--shiki-dark:#E1E4E8">([]</span><span style="color:#D73A49;--shiki-dark:#F97583">byte</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"hello world"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">))</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>What Caleb did was string concatenation in memory, creating a big string in memory and then calling the system function to print it out only once.
Indeed this is way more performant than making an IO syscall every iteration.</p>
<p>Since Caleb did not provide an equal program in Assembly, I decided to fill this gap.
I have spent quite some time (predominantly because I am quite rusty with Assembly at the moment and I forgot that different OSes use <a href="https://en.wikipedia.org/wiki/X86_calling_conventions">different calling conventions</a>).
I came up with the code in Assembly that does exactly the same - allocates the memory, fills it with the repeated <code>"hello world"</code> string and then makes a syscall to print it to the console.</p>
<h3 id="my-optimized-assembly">My optimized Assembly</h3>
<div class="content-read-marker" data-fraction="25"></div>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="asm"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; compile me on OSX: nasm -fmacho64 helloworld.asm &#x26;&#x26; ld helloworld.o -lSystem -macosx_version_min 10.13</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; compile me on Linux: nasm -felf64 helloworld.asm &#x26;&#x26; ld helloworld.o # AND DO NOT FORGET TO ALIGN WITH THE SYSCALL CONVENTION BY USING STACK INSTEAD OF REGISTERS</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">global</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">extern</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _malloc, _puts, _atoi, _free</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">section .text</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">_main:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">load_counter:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    cmp</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jne</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .exit_failure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r13</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> + </span><span style="color:#005CC5;--shiki-dark:#79B8FF">8</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _atoi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r13</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">calculate_memory_length:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, len</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    imul</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    inc</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">allocate_memory:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _malloc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    test</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jz</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .exit_failure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">repeat_message:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">repeat_message_1:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    lea</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#D73A49;--shiki-dark:#F97583">rel</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> msg]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, len</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    cld</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">copy_message:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">], </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    inc</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    inc</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    dec</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jnz</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .copy_message</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">repeat_message_2:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    dec</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jnz</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .repeat_message_1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">], </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">print_string_builder:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _puts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">free_memory:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _free</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exit_success:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jmp</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .exit</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exit_failure:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exit:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0x02000001</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    syscall</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">section .data</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">msg:</span><span style="color:#D73A49;--shiki-dark:#F97583"> db</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> "Hello, world", </span><span style="color:#005CC5;--shiki-dark:#79B8FF">10</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">len </span><span style="color:#005CC5;--shiki-dark:#79B8FF">equ</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> $ - msg</span></span>
<span class="line"></span></code></pre>
<div class="content-read-marker" data-fraction="50"></div>
<h3 id="my-version-with-logs">My version with logs</h3>
<p>As Caleb highlights in his blog, a lot of ‚Äúburden‚Äù introduced by many languages (referring to the original blog by Drew DeVault) is the debugging and safety related information.</p>
<p>I went ahead and added few logs, memory deallocation and test for allocation success to the code in Assembly:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="asm"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; compile me on OSX: nasm -fmacho64 helloworld.asm &#x26;&#x26; ld helloworld.o -lSystem -macosx_version_min 10.13</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; compile me on Linux: nasm -felf64 helloworld.asm &#x26;&#x26; ld helloworld.o # AND DO NOT FORGET TO ALIGN WITH THE SYSCALL CONVENTION BY USING STACK INSTEAD OF REGISTERS</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">global</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _main </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; a function declaration - an entry point; use `_start` for Linux</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">extern</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _malloc, _puts, _atoi, _printf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">section .text</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">_main:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">load_counter:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r13</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    cmp</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; check ARGC - program takes exactly ONE argument, so checking if ARGC == 2 (first one being program name)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jne</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .exit_failure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; log</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; store ARGC in R12</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r13</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> + </span><span style="color:#005CC5;--shiki-dark:#79B8FF">8</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; store the ARGV[2] (by addressing it with *(ARGV + 1)) in R13</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; preserve all the used registers on stack - required by OSX calling convention</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, log1 </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; copy format string to RDI</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; copy first argument for _printf to RSI</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; copy second argument for _printf to RDX</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; zero out RAX to enable variable function arguments</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _printf </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; syscall to printf()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdx</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; restore the registers' values</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; end log</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    ; mov r12, rsi ;; pointer to argv (which is a pointer on its own)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; move the address of argv[1] (r12 + 0 => argv[0], r12 + 8 => argv[1]) to rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _atoi </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; convert char* argv[1] to int and store the result in rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r13</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; store counter as int in r13</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; log</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, log2</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _printf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">;; end log</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">calculate_memory_length:</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">    ;; rdi = counter * len</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, len</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    imul</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    inc</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; +1 for the terminal character (\0)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; store total length in r12</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">allocate_memory:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; number of bytes to allocate</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _malloc</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    test</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; test the return code of _malloc syscall</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jz</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .exit_failure </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; if it is an error - go to exit(1)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> r12</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; store address in r12</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">repeat_message:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r13</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; set outer loop counter to COUNTER</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; set destination address to the stored address from malloc call</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">repeat_message_1:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; push outer loop counter onto stack - we don't need it just yet, but will need it after the inner loop is done</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    lea</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#D73A49;--shiki-dark:#F97583">rel</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> msg] </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; load address of our message to repeat into the source address</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, len </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; set inner loop counter to the length of a message</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    cld</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; reset the string copying direction flag</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">copy_message:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rsi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] </span><span style="color:#6A737D;--shiki-dark:#6A737D">;; load the next byte from the source memory</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">], </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; copy the loaded byte to the destination memory</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    inc</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rsi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; advance source pointer</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    inc</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; advamce destimation pointer</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    dec</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; decrease the inner loop counter</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jnz</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .copy_message</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">repeat_message_2:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; restore the outer loop counter</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    dec</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rcx</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; decrement the outer loop counter</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jnz</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .repeat_message_1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">], </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; put \0 at current RDI</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">print_string_builder:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    push</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">r12</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; set first argument to the allocated memory start</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rax</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    call</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _puts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    pop</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exit_success:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    xor</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">rdi</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; exit argument - exit status - 0</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    jmp</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> .exit</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exit_failure:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rdi</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">exit:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    mov</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> rax</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0x02000001</span><span style="color:#6A737D;--shiki-dark:#6A737D"> ;; syscall id - exit; use `60` for Linux</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    syscall</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">section .data</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">msg:</span><span style="color:#D73A49;--shiki-dark:#F97583"> db</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> "Hello, world", </span><span style="color:#005CC5;--shiki-dark:#79B8FF">10</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">len </span><span style="color:#005CC5;--shiki-dark:#79B8FF">equ</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> $ - msg</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">log1:</span><span style="color:#D73A49;--shiki-dark:#F97583"> db</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> "argc = %d, argv[</span><span style="color:#005CC5;--shiki-dark:#79B8FF">1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] = %s", </span><span style="color:#005CC5;--shiki-dark:#79B8FF">10</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">log2:</span><span style="color:#D73A49;--shiki-dark:#F97583"> db</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> "atoi = %d", </span><span style="color:#005CC5;--shiki-dark:#79B8FF">10</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span></span>
<span class="line"></span></code></pre>
<h2 id="comparison">Comparison</h2>
<p>Finally, I ran the aforementioned programs with the following arguments: <code>1M</code>, <code>2.5M</code>, <code>5M</code>, <code>7.5M</code>, <code>10M</code>, <code>12.5M</code>, <code>15M</code> and <code>17.5M</code> (where <code>M</code> stands for ‚Äúmillion‚Äù).</p>
<p>The results became more reasonable:</p>
<img alt="" data-src="/images/a-response-to-response-to-hello-world/go_vs_asm_hello_world-min.webp">
<div class="content-read-marker" data-fraction="100"></div> </div>  </article><article> <h1> <a href="/2019/12/11/2019-12-11-linq-is-awesome-right.html">Linq is awesome, right?</a> </h1> <time datetime="2019-12-11T02:49:39.000Z"> Dec 11, 2019 </time> <div class="content"> <p>Recently I‚Äôve seen a curious blog on Dev.to, <a href="https://dev.to/sduduzog/c-and-net-core-appreciation-post-the-most-beautiful-piece-of-code-i-have-ever-seen-this-month-49gf">C# and .NET Core Appreciation Post. The most beautiful piece of code I have ever seen‚Ä¶ this month!</a>.</p>
<p>In short, author was amazed by how beautiful Linq is, supporting their feelings with this code snippet:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  var</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> user</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">from</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> u</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Users</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">              join</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> t</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tokens </span><span style="color:#D73A49;--shiki-dark:#F97583">on</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> u.Id </span><span style="color:#D73A49;--shiki-dark:#F97583">equals</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> t.UserId</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">              where</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> t.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">              select</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> u).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">SingleOrDefault</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">  return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> user;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Let‚Äôs tear this example apart and check how really <del>performant</del> beautiful Linq is!</p>
<!--more-->
<p>The boilerplate code to make the thing not fall apart:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">using</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> System</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">using</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> System</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Collections</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Generic</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">using</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> System</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Linq</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Id</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="color:#D73A49;--shiki-dark:#F97583">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; </span><span style="color:#D73A49;--shiki-dark:#F97583">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Id</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.Id </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Id;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> UserId</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="color:#D73A49;--shiki-dark:#F97583">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; </span><span style="color:#D73A49;--shiki-dark:#F97583">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Body</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="color:#D73A49;--shiki-dark:#F97583">get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; </span><span style="color:#D73A49;--shiki-dark:#F97583">set</span><span style="color:#24292E;--shiki-dark:#E1E4E8">; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> UserId</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Body</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.UserId </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> UserId;</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Body;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Context</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Users</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>();</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Tokens</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        var</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> user</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">from</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> u</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Users</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                    join</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> t</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tokens </span><span style="color:#D73A49;--shiki-dark:#F97583">on</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> u.Id </span><span style="color:#D73A49;--shiki-dark:#F97583">equals</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> t.UserId</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                    where</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> t.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                    select</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> u).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">SingleOrDefault</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> user;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#D73A49;--shiki-dark:#F97583"> class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> MainClass</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#D73A49;--shiki-dark:#F97583"> void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="color:#6F42C1;--shiki-dark:#B392F0">args</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        Context</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> context</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Context</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        context.Users.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1001"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        context.Users.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1002"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        context.Users.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1006"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        context.Tokens.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1002"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Weirdo"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        context.Tokens.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1001"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Waldo"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">        // at this point we want to start counting accesses from scratch</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        Console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">WriteLine</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"---"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        Console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">WriteLine</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"User by token {0} = {1}"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Waldo"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, context.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Waldo"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>I am going to modify it slightly for the sake of metrics a bit later, but first let us see what
code does C# generate in order for those magical SQL-like operators to do their thing. I am using <a href="https://sharplab.io/">https://sharplab.io/</a> for that purpose.</p>
<p>The code generated for <code>Context#GetUserByToken</code>:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6F42C1;--shiki-dark:#B392F0">CompilerGenerated</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">private</span><span style="color:#D73A49;--shiki-dark:#F97583"> sealed</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> class &#x3C;>c__DisplayClass2_0</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    internal</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> bool &#x3C;GetUserByToken></span><span style="color:#6F42C1;--shiki-dark:#B392F0">b__3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(&#x3C;>f__AnonymousType0&#x3C;User, Token> &#x3C;>h__TransparentIdentifier0)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">h__TransparentIdentifier0.t.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Serializable</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6F42C1;--shiki-dark:#B392F0">CompilerGenerated</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">private</span><span style="color:#D73A49;--shiki-dark:#F97583"> sealed</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> class &#x3C;>c</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#D73A49;--shiki-dark:#F97583"> readonly</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> &#x3C;>c &#x3C;>9 </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#6F42C1;--shiki-dark:#B392F0">c</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Func&#x3C;User, string> &#x3C;>9__2_0;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Func&#x3C;Token, string> &#x3C;>9__2_1;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Func&#x3C;User, Token, &#x3C;>f__AnonymousType0&#x3C;User, Token>> &#x3C;>9__2_2;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Func&#x3C;&#x3C;>f__AnonymousType0&#x3C;User, Token>, User> &#x3C;>9__2_4;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    internal</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> string &#x3C;GetUserByToken></span><span style="color:#6F42C1;--shiki-dark:#B392F0">b__2_0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> u</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> u.Id;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    internal</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> string &#x3C;GetUserByToken></span><span style="color:#6F42C1;--shiki-dark:#B392F0">b__2_1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> t</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> t.UserId;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    internal</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> &#x3C;>f__AnonymousType0&#x3C;User, Token> &#x3C;GetUserByToken></span><span style="color:#6F42C1;--shiki-dark:#B392F0">b__2_2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> u</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> t</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#6F42C1;--shiki-dark:#B392F0">f__AnonymousType0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(u, t);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    internal</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> User &#x3C;GetUserByToken></span><span style="color:#6F42C1;--shiki-dark:#B392F0">b__2_4</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(&#x3C;>f__AnonymousType0&#x3C;User, Token> &#x3C;>h__TransparentIdentifier0)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#D73A49;--shiki-dark:#F97583"> &#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">h__TransparentIdentifier0.u;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    &#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c__DisplayClass2_0 </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c__DisplayClass2_ </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#6F42C1;--shiki-dark:#B392F0">c__DisplayClass2_0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    &#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c__DisplayClass2_.token </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">SingleOrDefault</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Select</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Where</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Join</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(Users, Tokens, </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_0</span><span style="color:#D73A49;--shiki-dark:#F97583"> ??</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_0</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#005CC5;--shiki-dark:#79B8FF">9</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">b__2_0)), </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_1</span><span style="color:#D73A49;--shiki-dark:#F97583"> ??</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_1</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#005CC5;--shiki-dark:#79B8FF">9</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">b__2_1)), </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_2</span><span style="color:#D73A49;--shiki-dark:#F97583"> ??</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_2</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, &#x3C;></span><span style="color:#6F42C1;--shiki-dark:#B392F0">f__AnonymousType0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>>(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#005CC5;--shiki-dark:#79B8FF">9</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">b__2_2))), new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;&#x3C;></span><span style="color:#6F42C1;--shiki-dark:#B392F0">f__AnonymousType0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>, </span><span style="color:#D73A49;--shiki-dark:#F97583">bool</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c__DisplayClass2_.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">b__3)), </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_4</span><span style="color:#D73A49;--shiki-dark:#F97583"> ??</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_4</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;&#x3C;></span><span style="color:#6F42C1;--shiki-dark:#B392F0">f__AnonymousType0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#005CC5;--shiki-dark:#79B8FF">9</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">b__2_4))));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>If you format it a bit, you might see few issues with it:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    &#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c__DisplayClass2_0 </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c__DisplayClass2_ </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#6F42C1;--shiki-dark:#B392F0">c__DisplayClass2_0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    &#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c__DisplayClass2_.token </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">SingleOrDefault</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Select</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Where</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Join</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                    Users,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                    Tokens,</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                    &#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_0</span><span style="color:#D73A49;--shiki-dark:#F97583"> ??</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_0</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#005CC5;--shiki-dark:#79B8FF">9</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">b__2_0)),</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                    &#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_1</span><span style="color:#D73A49;--shiki-dark:#F97583"> ??</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_1</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#005CC5;--shiki-dark:#79B8FF">9</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">b__2_1)),</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                    &#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_2</span><span style="color:#D73A49;--shiki-dark:#F97583"> ??</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_2</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, &#x3C;></span><span style="color:#6F42C1;--shiki-dark:#B392F0">f__AnonymousType0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>>(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#005CC5;--shiki-dark:#79B8FF">9</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">b__2_2))</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                ),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;&#x3C;></span><span style="color:#6F42C1;--shiki-dark:#B392F0">f__AnonymousType0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>, </span><span style="color:#D73A49;--shiki-dark:#F97583">bool</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c__DisplayClass2_.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">b__3)),</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                &#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_4</span><span style="color:#D73A49;--shiki-dark:#F97583"> ??</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#B31D28;font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic">9__2_4</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;&#x3C;></span><span style="color:#6F42C1;--shiki-dark:#B392F0">f__AnonymousType0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#24292E;--shiki-dark:#E1E4E8">c.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;></span><span style="color:#005CC5;--shiki-dark:#79B8FF">9</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">b__2_4))</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        )</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Now remove those mangled names:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6F42C1;--shiki-dark:#B392F0">CompilerGenerated</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">private</span><span style="color:#D73A49;--shiki-dark:#F97583"> sealed</span><span style="color:#D73A49;--shiki-dark:#F97583"> class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Result</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    internal</span><span style="color:#D73A49;--shiki-dark:#F97583"> bool</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> IsMatching</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">userTokenPair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> userTokenPair.Second.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Serializable</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#6F42C1;--shiki-dark:#B392F0">CompilerGenerated</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">private</span><span style="color:#D73A49;--shiki-dark:#F97583"> sealed</span><span style="color:#D73A49;--shiki-dark:#F97583"> class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> c</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#D73A49;--shiki-dark:#F97583"> readonly</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> c</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> cInstance</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> c</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">fn1</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">fn2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">fn3</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">fn4</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    internal</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> string &#x3C;GetUserByToken></span><span style="color:#6F42C1;--shiki-dark:#B392F0">GetUserId</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> u</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> u.Id;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    internal</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> string &#x3C;GetUserByToken></span><span style="color:#6F42C1;--shiki-dark:#B392F0">GetTokenUserId</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> t</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> t.UserId;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    internal</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Pair&#x3C;User, Token> &#x3C;GetUserByToken></span><span style="color:#6F42C1;--shiki-dark:#B392F0">MakeUserTokenPair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> u</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> t</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(u, t);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    internal</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> User &#x3C;GetUserByToken></span><span style="color:#6F42C1;--shiki-dark:#B392F0">GetUserFromUserTokenPair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> pair.u;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> searchToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    Result</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> result</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    result.token </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> searchToken;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">SingleOrDefault</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Select</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Where</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Join</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                    Users,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                    Tokens,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                    c.fn1 </span><span style="color:#D73A49;--shiki-dark:#F97583">??</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (c.fn1 </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(c.cInstance.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserId)),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                    c.fn2 </span><span style="color:#D73A49;--shiki-dark:#F97583">??</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (c.fn2 </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(c.cInstance.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetTokenUserId)),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                    c.fn3 </span><span style="color:#D73A49;--shiki-dark:#F97583">??</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (c.fn3 </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>>(c.cInstance.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">MakeUserTokenPair))</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                ),</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>, </span><span style="color:#D73A49;--shiki-dark:#F97583">bool</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(result.IsMatching)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            ),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            c.fn4 </span><span style="color:#D73A49;--shiki-dark:#F97583">??</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (c.fn4 </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Func</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(c.cInstance.</span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;</span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#24292E;--shiki-dark:#E1E4E8">GetUserFromUserTokenPair))</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        )</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>And, simplifying everything with lambdas:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> searchToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">SingleOrDefault</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Select</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Where</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Join</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                    Users,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                    Tokens,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">                    user</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> user.Id,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">                    token</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token.UserId,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                    (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">user</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(user, token)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                ),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                userTokenPair.Second.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> searchToken</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            ),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">            userTokenPair</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> userTokenPair.First</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        )</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>If you have not noticed the issue just yet, continue reading.</p>
<p>Now I am adding a simple debug output to check the calls LINQ makes whenever we call <code>Context#GetUserByToken</code>.
To do that, I am simply going to smash <code>Console.WriteLine</code> statement to each getter of both <code>User</code> and <code>Tag</code> classes:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    private</span><span style="color:#D73A49;--shiki-dark:#F97583"> string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> _Id</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Id</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        get</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { Console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">WriteLine</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"User&#x3C;{0}>.Id was accessed"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, _Id); </span><span style="color:#D73A49;--shiki-dark:#F97583">return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _Id; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        set</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { _Id </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> value; }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Id</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.Id </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Id;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    private</span><span style="color:#D73A49;--shiki-dark:#F97583"> string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> _UserId</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    private</span><span style="color:#D73A49;--shiki-dark:#F97583"> string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> _Body</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> UserId</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        get</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { Console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">WriteLine</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Token&#x3C;{0}>.UserId was accessed"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, _Body); </span><span style="color:#D73A49;--shiki-dark:#F97583">return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _UserId; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        set</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { _UserId </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> value; }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Body</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        get</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { Console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">WriteLine</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Token&#x3C;{0}>.Body was accessed"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, _Body); </span><span style="color:#D73A49;--shiki-dark:#F97583">return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> _Body; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        set</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> { _Body </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> value; }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> UserId</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Body</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.UserId </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> UserId;</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Body;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Seems like LINQ goes through all users and all their tokens:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>---</span></span>
<span class="line"><span>Token&#x3C;Weirdo>.UserId was accessed</span></span>
<span class="line"><span>Token&#x3C;Waldo>.UserId was accessed</span></span>
<span class="line"><span>User&#x3C;1001>.Id was accessed</span></span>
<span class="line"><span>Token&#x3C;Waldo>.Body was accessed</span></span>
<span class="line"><span>User&#x3C;1002>.Id was accessed</span></span>
<span class="line"><span>Token&#x3C;Weirdo>.Body was accessed</span></span>
<span class="line"><span>User&#x3C;1006>.Id was accessed</span></span>
<span class="line"><span></span></span></code></pre>
<p>If I was to add one more user like this</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">context.Users.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1008"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"></span></code></pre>
<p>then the lookup iterates over those ones too:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>---</span></span>
<span class="line"><span>Token&#x3C;Weirdo>.UserId was accessed</span></span>
<span class="line"><span>Token&#x3C;Waldo>.UserId was accessed</span></span>
<span class="line"><span>User&#x3C;1001>.Id was accessed</span></span>
<span class="line"><span>Token&#x3C;Waldo>.Body was accessed</span></span>
<span class="line"><span>User&#x3C;1002>.Id was accessed</span></span>
<span class="line"><span>Token&#x3C;Weirdo>.Body was accessed</span></span>
<span class="line"><span>User&#x3C;1006>.Id was accessed</span></span>
<span class="line"><span>User&#x3C;1008>.Id was accessed</span></span>
<span class="line"><span></span></span></code></pre>
<p>If I assign a token to that user, it also will be visited:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">context.Tokens.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1008"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Quattro"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"></span></code></pre>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>---</span></span>
<span class="line"><span>Token&#x3C;Weirdo>.UserId was accessed</span></span>
<span class="line"><span>Token&#x3C;Waldo>.UserId was accessed</span></span>
<span class="line"><span>Token&#x3C;Quattro>.UserId was accessed</span></span>
<span class="line"><span>User&#x3C;1001>.Id was accessed</span></span>
<span class="line"><span>Token&#x3C;Waldo>.Body was accessed</span></span>
<span class="line"><span>User&#x3C;1002>.Id was accessed</span></span>
<span class="line"><span>Token&#x3C;Weirdo>.Body was accessed</span></span>
<span class="line"><span>User&#x3C;1006>.Id was accessed</span></span>
<span class="line"><span>User&#x3C;1008>.Id was accessed</span></span>
<span class="line"><span>Token&#x3C;Quattro>.Body was accessed</span></span>
<span class="line"><span></span></span></code></pre>
<p>And it is quite well reflected in the generated code - LINQ essentially generates a list of pairs for every user and token matching a <code>join</code> condition:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> searchToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">tempCollection</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Join</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        Users,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        Tokens,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        user</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> user.Id,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        token</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token.UserId,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">user</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(user, token)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">SingleOrDefault</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Select</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Where</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                tempCollection,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                userTokenPair.Second.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> searchToken</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            ),</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">            userTokenPair</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> userTokenPair.First</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        )</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>If we continue extracting the calls to <code>Enumerable</code>, we will end up with something like this:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> searchToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">tempCollection</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Join</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        Users,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        Tokens,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        user</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> user.Id,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        token</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token.UserId,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">user</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">=></span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(user, token)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">matchingPairs</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Where</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        tempCollection,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        userTokenPair.Second.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> searchToken</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">transformedMatchingPairs</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Select</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        matchingPairs,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        userTokenPair</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> userTokenPair.First</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">SingleOrDefault</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        transformedMatchingPairs</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Now, <code>Enumerable.Join</code> is the only tricky instruction here. It makes that big temporary join table (talking SQL and relational databases).
It can be written as follows:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> searchToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">tempCollection</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> user</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Users) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> token</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tokens) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (user.Id </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token.UserId) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                tempCollection.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(user, token));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">matchingPairs</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Where</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        tempCollection,</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        userTokenPair.Second.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> searchToken</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">transformedMatchingPairs</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Select</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        matchingPairs,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        userTokenPair</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> userTokenPair.First</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">SingleOrDefault</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        transformedMatchingPairs</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>The <code>Enumerable.Where</code> call simply filters the collection:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> searchToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">tempCollection</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> user</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Users) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> token</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tokens) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (user.Id </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token.UserId) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                tempCollection.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(user, token));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">matchingPairs</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">userTokenPair</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> tempCollection) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (userTokenPair.Second.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> searchToken) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            matchingPairs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(userTokenPair);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">transformedMatchingPairs</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Select</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        matchingPairs,</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        userTokenPair</span><span style="color:#D73A49;--shiki-dark:#F97583"> =></span><span style="color:#24292E;--shiki-dark:#E1E4E8"> userTokenPair.First</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">SingleOrDefault</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        transformedMatchingPairs</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>The <code>Enumerable.Select</code> call maps the collection onto some other collection:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> searchToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">tempCollection</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> user</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Users) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> token</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tokens) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (user.Id </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token.UserId) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                tempCollection.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(user, token));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">matchingPairs</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">userTokenPair</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> tempCollection) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (userTokenPair.Second.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> searchToken) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            matchingPairs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(userTokenPair);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">transformedMatchingPairs</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">userTokenPair</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> matchingPairs) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        transformedMatchingPairs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(userTokenPair.First);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Enumerable.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">SingleOrDefault</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        transformedMatchingPairs</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>And finally, <code>Enumerable.SingleOrDefault</code> returns the first element of the collection or the default value (<code>null</code> in this case):</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> searchToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> result</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">tempCollection</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> user</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Users) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> token</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tokens) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (user.Id </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token.UserId) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                tempCollection.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>(user, token));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">matchingPairs</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">userTokenPair</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> tempCollection) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (userTokenPair.Second.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> searchToken) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            matchingPairs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(userTokenPair);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">transformedMatchingPairs</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> new </span><span style="color:#6F42C1;--shiki-dark:#B392F0">List</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Pair</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">userTokenPair</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> matchingPairs) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        transformedMatchingPairs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(userTokenPair.First);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (transformedMatchingPairs.Size </span><span style="color:#D73A49;--shiki-dark:#F97583">></span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">?</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> transformedMatchingPairs.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Get</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#D73A49;--shiki-dark:#F97583">:</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>If we remove the unnecessary (for us as the developers) transformations and intermediate collections, we will end up
with the code, <em>similar</em> to the naive implementation of the same logic with two nested loops:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> searchedToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> user</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Users) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        foreach</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> token</span><span style="color:#D73A49;--shiki-dark:#F97583"> in</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tokens) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (token.UserId </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> user.Id </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> token.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> searchedToken) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> user;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Except the naive implementation not generating a whole lot of code:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> searchedToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    List&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>.Enumerator enumerator </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Users.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">GetEnumerator</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    try</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        while</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (enumerator.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">MoveNext</span><span style="color:#24292E;--shiki-dark:#E1E4E8">())</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">            User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> current</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> enumerator.Current;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            List&#x3C;</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>.Enumerator enumerator2 </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> Tokens.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">GetEnumerator</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            try</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                while</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (enumerator2.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">MoveNext</span><span style="color:#24292E;--shiki-dark:#E1E4E8">())</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">                    Token</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> current2</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> enumerator2.Current;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                    if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (current2.UserId </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> current.Id </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x26;&#x26;</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> current2.Body </span><span style="color:#D73A49;--shiki-dark:#F97583">==</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> searchedToken)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                    {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">                        return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> current;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">            finally</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">                ((</span><span style="color:#6F42C1;--shiki-dark:#B392F0">IDisposable</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)enumerator2).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Dispose</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    finally</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        ((</span><span style="color:#6F42C1;--shiki-dark:#B392F0">IDisposable</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)enumerator).</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Dispose</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="color:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>The real difference, however, is in the exact environment the code is running in:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>---</span></span>
<span class="line"><span>Token&#x3C;Weirdo>.UserId was accessed</span></span>
<span class="line"><span>User&#x3C;1001>.Id was accessed</span></span>
<span class="line"><span>Token&#x3C;Waldo>.UserId was accessed</span></span>
<span class="line"><span>User&#x3C;1001>.Id was accessed</span></span>
<span class="line"><span>Token&#x3C;Waldo>.Body was accessed</span></span>
<span class="line"><span></span></span></code></pre>
<p>So in the good-case-scenario, naive implementation <del>beats</del> does fewer operations than the LINQ code.</p>
<p>The issue with both approaches is in the worst-case-scenario, which, as I have learned by heart, is the only possible scenario.
They both are going to run in <code>O(n^2)</code> time at worst.</p>
<p>Let‚Äôs consider a small optimization, using <em>indexes</em>:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Context</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    private</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Dictionary</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">UserByToken</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Dictionary</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    private</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Dictionary</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">> </span><span style="color:#6F42C1;--shiki-dark:#B392F0">UserById</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Dictionary</span><span style="color:#24292E;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">>();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> AddUser</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> u</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      Users.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(u);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      UserById[u.Id] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> u;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> AddToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Token</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> t</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      Tokens.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">Add</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(t);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">      UserByToken[t.Body] </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> UserById[t.UserId];</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> GetUserByToken2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">        return</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> UserByToken[token];</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">// then the main method needs to be adjusted correspondingly:</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">public</span><span style="color:#D73A49;--shiki-dark:#F97583"> class</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> MainClass</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    public</span><span style="color:#D73A49;--shiki-dark:#F97583"> static</span><span style="color:#D73A49;--shiki-dark:#F97583"> void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Main</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">string</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="color:#6F42C1;--shiki-dark:#B392F0">args</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">        Context</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> context</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#D73A49;--shiki-dark:#F97583"> new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Context</span><span style="color:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        context.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">AddUser</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1001"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        context.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">AddUser</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1002"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        context.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">AddUser</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1006"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        context.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">AddUser</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> User</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1008"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        context.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">AddToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1002"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Weirdo"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        context.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">AddToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1001"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Waldo"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        context.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">AddToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Token</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"1008"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Quattro"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D">        // at this point we want to start counting accesses from scratch</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        Console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">WriteLine</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"---"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        Console.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">WriteLine</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"User by token {0} = {1}"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Waldo"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, context.</span><span style="color:#6F42C1;--shiki-dark:#B392F0">GetUserByToken</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Waldo"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Essentially, whenever we add any user or tag, we put them in a dictionary <em>(an index)</em> in memory.</p>
<p>Okay, we sacrifice some memory, but do we earn anything from it?</p>
<p>The output of the program is very short:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>User&#x3C;1001>.Id was accessed</span></span>
<span class="line"><span>User&#x3C;1002>.Id was accessed</span></span>
<span class="line"><span>User&#x3C;1006>.Id was accessed</span></span>
<span class="line"><span>User&#x3C;1008>.Id was accessed</span></span>
<span class="line"><span>Token&#x3C;Weirdo>.Body was accessed</span></span>
<span class="line"><span>Token&#x3C;Weirdo>.UserId was accessed</span></span>
<span class="line"><span>Token&#x3C;Waldo>.Body was accessed</span></span>
<span class="line"><span>Token&#x3C;Waldo>.UserId was accessed</span></span>
<span class="line"><span>Token&#x3C;Quattro>.Body was accessed</span></span>
<span class="line"><span>Token&#x3C;Quattro>.UserId was accessed</span></span>
<span class="line"><span>---</span></span>
<span class="line"><span>User by token Waldo = User</span></span>
<span class="line"><span></span></span></code></pre>
<p>So essentially, no collection is iterated. The access to the required object is immediate.</p>
<p>One might argue that the examples here are very synthetic and do not showcase anything.
But imagine a real product with millions or even billions of entities like those.
Think an average Google-size organization using Jira. Now replace <code>User</code> with <code>Issue</code> and <code>Token</code> with <code>Comment</code>.
I can assure you, the numbers would be 10-folded.</p>
<p>Contra: the code is written to be read (more often than not) and deleted (my favourite scenario).
So even thought hashmaps might seem appealing, indexing on few more fields might make the code hard to maintain.
This is especially crucial for long-lasting projects, where developers come and go as the time passes.
So <em>sometimes</em> this might be a necessary evil.</p>
<p>But sometimes it is best to know the theory rather than the tool.</p> </div>  </article> </section> </main> <footer> <nav> <div class="prev"> <a href="/page3.html" class="next">&larr; Previous page</a> </div> <div class="current">Page #4 of 11</div> <div class="next"> <a href="/page5.html" class="next">Next page &rarr;</a> </div> </nav> </footer> </body></html>