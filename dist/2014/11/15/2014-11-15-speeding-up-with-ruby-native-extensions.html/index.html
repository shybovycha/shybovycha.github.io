<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.0.3"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://shybovycha.github.io/2014/11/15/2014-11-15-speeding-up-with-ruby-native-extensions.html/"><!-- Primary Meta Tags --><title>Speeding up with Ruby native extensions</title><meta name="title" content="Speeding up with Ruby native extensions"><meta name="description"><link rel="stylesheet" href="/_astro/index.BvFNhZYw.css">
<style>footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
[data-astro-image]{width:100%;height:auto;object-fit:var(--fit);object-position:var(--pos);aspect-ratio:var(--w) / var(--h)}[data-astro-image=responsive]{max-width:calc(var(--w) * 1px);max-height:calc(var(--h) * 1px)}[data-astro-image=fixed]{width:calc(var(--w) * 1px);height:calc(var(--h) * 1px)}
</style></head> <body data-astro-cid-bvzihdzo> <nav class="top"> <div class="links"> <a class="nav-link nav-item" href="/">Home</a> <a class="nav-link nav-item" href="/about.html">About</a> </div> </nav> <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="hero-image" data-astro-cid-bvzihdzo>  </div> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2014-11-14T23:21:00.000Z"> Nov 15, 2014 </time>  </div> <h1 data-astro-cid-bvzihdzo>Speeding up with Ruby native extensions</h1> <hr data-astro-cid-bvzihdzo> </div>  <img alt="" src="/images/tumblr/speeding-up-with-ruby-native-extensions/tumblr_inline_pk2rhkfkxb1qh5oee_500.webp">
<h2 id="foreword">Foreword</h2>
<p>At my job, our current project has many bottle-necks, where Ruby really sucks on its performance. We were thinking on how to optimize them, and finally come to usage of Ruby Native API.</p>
<p>Our project uses Redis and MySQL hardly, so much of statistic data is stored in Redis. For speeding up. But one fine day made us use a <strong>reduce</strong> on a set of statistic data from Redis. And that’s where we got stuck on Ruby’ performance. Our server timed out in a minute of waiting for that reduce to complete.</p>
<!--more-->
<p>The trouble was in a loop like this:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ruby"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">json_data </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> JSON</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.pase(json_file)</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">keys </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> $redis.keys </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"*:hash_pattern:date:*"</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">count, total_count </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">keys.each </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> |hash_key|</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    elements </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> $redis.hgetall hash_key</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    elements.each </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> |key, value|</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        i_value </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> value.to_i</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        count </span><span style="color:#D73A49;--shiki-dark:#F97583">+=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> i_value </span><span style="color:#D73A49;--shiki-dark:#F97583">if</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> key </span><span style="color:#D73A49;--shiki-dark:#F97583">=~</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> /</span><span style="color:#032F62;--shiki-dark:#DBEDFF">some:regex</span><span style="color:#032F62;--shiki-dark:#9ECBFF">/</span><span style="color:#D73A49;--shiki-dark:#F97583"> and</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> json_data.has_key? key</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">        total_count </span><span style="color:#D73A49;--shiki-dark:#F97583">+=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> i_value</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    end</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">end</span></span>
<span class="line"></span></code></pre>
<p>My first attempt was implemented on a D language. But when I tried to use the compiled code library with Ruby, I failed. That’s why I thought <em>I feel more comfortable with C/C++ than with D</em>. And wrote the same code on C/C++. I took three third-party libraries:</p>
<ul>
<li><code>RE2</code> for regular expressions</li>
<li><code>hiredis</code> for Redis operations</li>
<li><code>rapidjson</code> for JSON parsing</li>
</ul>
<p>But when I compiled and ran what I’ve done, I could not believe my eyes - the process worked for <strong>59 seconds</strong>!
That was more than <strong>ten times</strong> slower than Ruby version!</p>
<p>So, I started optimizing for speed.</p>
<img alt="" src="/images/tumblr/speeding-up-with-ruby-native-extensions/tumblr_inline_pk2rhkUOes1qh5oee_500.webp">
<!--more-->
<p>First of all, I dropped regular expressions as they were simply replaced by substring check and substring extraction (as the first part of a string in a regular expression had a fixed length). That did the trick, lowering the execution time to <strong>25 seconds</strong>. Yet, it was too much.</p>
<p>The last step I took, I removed hiredis and replaced it with a set of five custom functions, performing only those operations, which we needed via sockets. First, that failed with a really, REALLY long segfault. Yet, when I replaced the host string from <em>“localhost”</em> to <em>“127.0.0.1”</em>, my tiny extension arose and did its job in <strong>4.8 seconds</strong>.</p>
<p>That was great! Yet, it is not the best time I can get, let’s take a look on what was done and in which manner.</p>
<h2 id="creating-native-extensions-for-ruby">Creating native extensions for Ruby</h2>
<p>Creating a native extension will need you to have compiled <strong>shared object</strong> file. Shared object is a library for POSIX OSes.
There are two kinds of library formats for Linux and others:</p>
<ul>
<li><strong>shared libraries</strong> (<code>*.so</code> files) - could be placed anywhere and used in a runtime by a few applications</li>
<li><strong>static libraries</strong> (<code>*.a</code> files) - are bundled to a compile target (library, executable…) and are used in that environment</li>
</ul>
<p>For that purpose you’d better use <strong>C/C++ Ruby API</strong>.
Yes, you <em>could</em> use other-language-compiled shared libraries, but through an interface called <strong>FFI</strong>,
which I did not manage to work for me. Thus, this article covers only the C/C++ way.</p>
<p>To make your extension available in Ruby, you will need to define some of these:</p>
<ul>
<li>method for existing classes and modules</li>
<li>new class or module</li>
</ul>
<p>All of them are not hard to implement. We will make our own module and define its method.</p>
<p>First, create a directory names as your extension will be named. Let’s say, <code>my_ext</code>. Create two files there - <code>my_ext.cpp</code> and <code>extconf.rb</code>.
First file will define an extension shared library, whilst the second one will create <code>Makefile</code> for us.</p>
<p>Our extension will have a very simple source file with just one non-standard include and two functions defined:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">#include</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "ruby.h"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">#include</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> &#x3C;string.h></span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">#include</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> &#x3C;stdlib.h></span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">VALUE </span><span style="color:#6F42C1;--shiki-dark:#B392F0">moo_method</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(VALUE </span><span style="color:#E36209;--shiki-dark:#FFAB70">_name</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, VALUE </span><span style="color:#E36209;--shiki-dark:#FFAB70">_age</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, VALUE </span><span style="color:#E36209;--shiki-dark:#FFAB70">_self</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    char*</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> name </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> StringValueCStr</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(_name);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    unsigned</span><span style="color:#D73A49;--shiki-dark:#F97583"> int</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> age </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> num2uint</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(_age);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    char*</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> result </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="color:#D73A49;--shiki-dark:#F97583">char*</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) </span><span style="color:#6F42C1;--shiki-dark:#B392F0">malloc</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">255</span><span style="color:#D73A49;--shiki-dark:#F97583"> *</span><span style="color:#D73A49;--shiki-dark:#F97583"> sizeof</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#D73A49;--shiki-dark:#F97583">char</span><span style="color:#24292E;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">    sprintf</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(result, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"Hello, my name is </span><span style="color:#005CC5;--shiki-dark:#79B8FF">%s</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> and I am </span><span style="color:#005CC5;--shiki-dark:#79B8FF">%d</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> years old!</span><span style="color:#005CC5;--shiki-dark:#79B8FF">\n</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, name, age);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">    return</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> rb_str_new2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(result);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">extern</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "C"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">void</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> Init_my_ext</span><span style="color:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  VALUE MyModule </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> rb_define_module</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">"MyModule"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">  rb_define_module_function</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(MyModule, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">"moo"</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#6F42C1;--shiki-dark:#B392F0">reinterpret_cast</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(moo), </span><span style="color:#005CC5;--shiki-dark:#79B8FF">2</span><span style="color:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Now let’s look at this source. There is only one exported function, <code>Init_my_ext</code>. That’s correct, because all our extension needs to do is to define something. And that is done in that method. The function <code>Init_my_ext</code> should have such name format: <code>Init_$extension_name$</code>. That’s how Ruby finds out what to call first.</p>
<p>Now, there are many of those <code>VALUE</code> type instances. That is internal type of Ruby Native API. That is the variant type, holding Ruby’ value. And whilst Ruby is not strongly typed language, that type could contain anything - from <code>nil</code> to <code>string</code> and even <code>object</code>. There are a few really useful functions defined in <code>ruby.h</code> to help you checking variables for types and converting them to C++ types.</p>
<p>Then we define a module named <code>MyModule</code> and stored its reference in the <code>MyModule</code> variable. Then we can do what we want with that module - define classes, variables and methods. Let’s see how we defined a method. Function <code>rb_define_module_function</code> contains four arguments:</p>
<ul>
<li><strong>reference to a module</strong></li>
<li><strong>method name</strong></li>
<li><strong>pointer to a C function, representing method internals</strong> - note the <code>reinterpret_cast</code></li>
<li><strong>argument count</strong> - when this number is less than zero, than method will receive three arguments - <code>int argc</code>, <code>VALUE* argv</code> and <code>VALUE self</code>, representing variable amount of arguments; if this number is greater than zero - it defines the amount of required method arguments</li>
</ul>
<p>Now, lets create a <code>extconf.rb</code> file, which will create <code>Makefile</code> for final library compilation:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ruby"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">require</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'mkmf'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">extension_name </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'my_ext'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">def</span><span style="color:#6F42C1;--shiki-dark:#B392F0"> get_dir</span><span style="color:#24292E;--shiki-dark:#E1E4E8">(name)</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">    File</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.expand_path(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">File</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.join(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">File</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.dirname(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">__FILE__</span><span style="color:#24292E;--shiki-dark:#E1E4E8">), name))</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">LIBDIR</span><span style="color:#D73A49;--shiki-dark:#F97583">     =</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> RbConfig</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">CONFIG</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'libdir'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">INCLUDEDIR</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> RbConfig</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">CONFIG</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'includedir'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">HEADER_DIRS</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">INCLUDEDIR</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"># setup constant that is equal to that of the file path that holds that static libraries that will need to be compiled against</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">LIB_DIRS</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">LIBDIR</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">libs </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> []</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"># The destination</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">dir_config(extension_name, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">HEADER_DIRS</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">LIB_DIRS</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">libs.each </span><span style="color:#D73A49;--shiki-dark:#F97583">do</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> |lib|</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">    $LOCAL_LIBS </span><span style="color:#D73A49;--shiki-dark:#F97583">&#x3C;&#x3C;</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "</span><span style="color:#032F62;--shiki-dark:#9ECBFF">#{lib}</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> "</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"># Additional compiler / linker flags</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"># $CFLAGS &#x3C;&#x3C; " -fPIC "</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"># $LDFLAGS &#x3C;&#x3C; " -lpthread "</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#6A737D"># Do the work</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">create_makefile(extension_name)</span></span>
<span class="line"></span></code></pre>
<p>That’s it, it defines parameters for our future <code>Makefile</code>. Note the <code>get_dir(name)</code> method - I’ve defined it for you to simplify adding library sub-directories to the <code>LIBDIR</code> and <code>INCLUDEDIR</code> arrays, just like this:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ruby"><code><span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">LIB_DIRS</span><span style="color:#D73A49;--shiki-dark:#F97583"> =</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ </span><span style="color:#005CC5;--shiki-dark:#79B8FF">LIBDIR</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, get_dir(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'hiredis'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">) ]</span></span>
<span class="line"></span></code></pre>
<p>Also, note the <code>-fPIC</code> option - it is needed for most libraries to compile under different architectures. So, you may need to add them to your third-party libraries’ Makefiles to resolve corresponding compiler errors when building the extension.</p>
<p>When you are done, let’s generate Makefile:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ruby"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">ruby extconf.rb</span></span>
<span class="line"></span></code></pre>
<p>Then, you should be able to build your shared object with</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">$</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> make</span></span>
<span class="line"></span></code></pre>
<p>Using our extension is simple when playing around locally - you just add it to your <code>irb</code> or <code>ruby</code> command-line arguments like this:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">$</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> irb</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> -r</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> ./my_ext.so</span></span>
<span class="line"></span></code></pre>
<p>And then just using the modules you’ve defined. But in most situations, that is impossible, as, for example, you are running a Rails application on a production server. So, you will probably want a RubyGem for that purpose.</p>
<h2 id="wrapping-extension-in-a-gem">Wrapping extension in a Gem</h2>
<p>Building a Ruby Gem containing native extension is a little different than building usual gems. You here have two options:</p>
<ul>
<li>bundle a pre-built library with a gem</li>
<li>provide a sources to perform build on a target machine</li>
</ul>
<p>First way is for dummies. That’s it, you will probably want your code ran on different platforms than your own machine. So, you will not want your gem to fail with a segfault like <em>this architecture differs from what the library was built on</em>. Thus, we will concentrate on a second way.</p>
<img alt="" src="/images/tumblr/speeding-up-with-ruby-native-extensions/tumblr_inline_pk2rhlqx0j1qh5oee_500.webp">
<p>First, we will need a correct directory structure:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>.</span></span>
<span class="line"><span>├── ext</span></span>
<span class="line"><span>│   └── my_gemname</span></span>
<span class="line"><span>│       ├── extconf.rb</span></span>
<span class="line"><span>│       └── my_ext.cpp</span></span>
<span class="line"><span>├── lib</span></span>
<span class="line"><span>│   └── my_gemname.rb</span></span>
<span class="line"><span>└── my_gemname.gemspec</span></span>
<span class="line"><span></span></span></code></pre>
<p>File <code>lib/my_gemname.rb</code> will contain only the extension initialization call:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ruby"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">require</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'my_gemname/my_ext'</span></span>
<span class="line"></span></code></pre>
<p>Whilst the main difference hides in gemspec file:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ruby"><code><span class="line"><span style="color:#005CC5;--shiki-dark:#79B8FF">Gem</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">Specification</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.</span><span style="color:#D73A49;--shiki-dark:#F97583">new</span><span style="color:#D73A49;--shiki-dark:#F97583"> do</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> |spec|</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.name </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'my_gemname'</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.version </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> '0.1'</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.description </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'Some cool description here'</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.summary </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'Short description'</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.email </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'author@email.com'</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.homepage </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> ''</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.author </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> 'Author Name'</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.files </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> Dir</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'lib/**/*.rb'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> Dir</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'ext/**/*'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.platform </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> Gem</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">Platform</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">RUBY</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.require_paths </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'lib'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'ext'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ]</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.extensions </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> Dir</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'ext/my_gemname/extconf.rb'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#F97583">end</span></span>
<span class="line"></span></code></pre>
<p>Here four lines make the magick:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ruby"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.files </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> Dir</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'lib/**/*.rb'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">] </span><span style="color:#D73A49;--shiki-dark:#F97583">+</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> Dir</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'ext/**/*'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.platform </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> Gem</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">Platform</span><span style="color:#24292E;--shiki-dark:#E1E4E8">::</span><span style="color:#005CC5;--shiki-dark:#79B8FF">RUBY</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.require_paths </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> [ </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'lib'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'ext'</span><span style="color:#24292E;--shiki-dark:#E1E4E8"> ]</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">  spec.extensions </span><span style="color:#D73A49;--shiki-dark:#F97583">=</span><span style="color:#005CC5;--shiki-dark:#79B8FF"> Dir</span><span style="color:#24292E;--shiki-dark:#E1E4E8">[</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'ext/my_gemname/extconf.rb'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"></span></code></pre>
<p>They set, respectively:</p>
<ul>
<li>directories of the extension with all the files and sub-directories, needed to compile it</li>
<li>universal target platform</li>
<li>extension required path</li>
<li>path to the extension’ extconf file</li>
</ul>
<p>Now you can build your gem with</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">$</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> gem</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> build</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> my_gemname.gemspec</span></span>
<span class="line"></span></code></pre>
<p>Using the gemfile may require you never to push it to RubyGems repository. For example, when your gem is a very specific for the project you are working on, or it may conflict with your job contract. But you can’t simply specify the <code>path</code> attribute for your gem in the <code>Gemfile</code> - it just does not work!</p>
<p>Way to solve this lays beyound using custom repository. My solution was to create a directory under <code>lib/</code> sub-directory of our project:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>repository</span></span>
<span class="line"><span>└── gems</span></span>
<span class="line"><span>    └── my_gemname-0.1.gem</span></span>
<span class="line"><span></span></span></code></pre>
<p>Then, go to the <code>repository</code> directory (that’s important NOT to go to the <code>gems</code> subdir) and run this magic command:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#B392F0">$</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> gem</span><span style="color:#032F62;--shiki-dark:#9ECBFF"> generate_index</span></span>
<span class="line"></span></code></pre>
<p>This will make your repository directory look like this:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>repository</span></span>
<span class="line"><span>├── gems</span></span>
<span class="line"><span>│   └── my_gemname-0.1.gem</span></span>
<span class="line"><span>├── latest_specs.4.8</span></span>
<span class="line"><span>├── latest_specs.4.8.gz</span></span>
<span class="line"><span>├── prerelease_specs.4.8</span></span>
<span class="line"><span>├── prerelease_specs.4.8.gz</span></span>
<span class="line"><span>├── quick</span></span>
<span class="line"><span>│   └── Marshal.4.8</span></span>
<span class="line"><span>│       └── my_gemname-0.1.gemspec.rz</span></span>
<span class="line"><span>├── specs.4.8</span></span>
<span class="line"><span>└── specs.4.8.gz</span></span>
<span class="line"><span></span></span></code></pre>
<p>This directory now could be used as a RubyGems repository. Just like the <strong>rubygems.org</strong>! Just point your <strong>Gemfile</strong> to this directory:</p>
<pre class="astro-code astro-code-themes github-light github-dark" style="background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ruby"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E1E4E8">source </span><span style="color:#005CC5;--shiki-dark:#79B8FF">File</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.join(</span><span style="color:#032F62;--shiki-dark:#9ECBFF">'file://'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#005CC5;--shiki-dark:#79B8FF">File</span><span style="color:#24292E;--shiki-dark:#E1E4E8">.dirname(</span><span style="color:#005CC5;--shiki-dark:#79B8FF">__FILE__</span><span style="color:#24292E;--shiki-dark:#E1E4E8">), </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'lib'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">, </span><span style="color:#032F62;--shiki-dark:#9ECBFF">'repository'</span><span style="color:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"></span></code></pre>
<p>And an <strong>important note</strong>: keep your <code>Gemfile</code> and <code>Gemfile.lock</code> up-to date - use only <code>= latest.version</code> in the <code>Gemfile</code> when running with your native extension gem!</p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2024 Your name here. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://m.webtoo.ls/@astro" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on Mastodon</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/mastodon" data-astro-cid-sz7xmlte><path fill="currentColor" d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://twitter.com/astrodotbuild" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on Twitter</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/withastro/astro" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Astro's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> </div> </footer>  </body></html>