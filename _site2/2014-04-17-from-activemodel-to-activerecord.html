<meta name="layout" content="post">
<meta name="title" content="From ActiveModel to ActiveRecord">
<meta name="date" content="2014-04-17T12:47:00+02:00">
<meta name="tags" content="ruby,metaprogramming">
<meta name="tumblr_url" content="http://shybovycha.tumblr.com/post/82983429638/from-activemodel-to-activerecord">
<p>This short article covers some steps you need to implement to get your own <code>ActiveRecord</code> implementation.</p>

<p>Sample <code>ActiveModel</code> looks like this:</p>
<span class="k">class</span> <span class="nc">Posting</span>
  <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validations</span>

  <span class="nb">attr_accessor</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">:tags</span>

  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">save</span>
    <span class="n">set_default_values</span>

    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">new</span><span class="p">(</span><span class="n">attributes</span><span class="p">).</span><span class="nf">save</span>
  <span class="k">end</span>

  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">set_default_values</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>

<p>First trouble is that <code>ActiveModel</code> does not provide any attribute access API. Or I did not google enough. So we need to create our own!</p>

<p>Let us have an instance variable <code>@attributes</code> where we will store our model&#39; data. We need to define getter and setter methods for all the attributes of our model. This may be done with the <code>attr_accessor</code> method. But when user sets the value for some attribute, we should store that in our <code>@attributes</code> variable. And here is the first step to our black magic: <strong>we will override the <code>attr_accessor</code> method</strong>.</p>
<span class="k">module</span> <span class="nn">ActiveAttributes</span>
  <span class="k">def</span> <span class="nf">attr_accessor</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">args</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span>
      <span class="n">define_method</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">"</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span> <span class="p">{</span> <span class="vi">@attributes</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span> <span class="p">}</span>
      <span class="n">define_method</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">="</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span> <span class="vi">@attributes</span><span class="p">[</span><span class="n">k</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<p>I just wrapped the code into a single module. Remember: when you include the module in a class, all the module&#39; methods become class methods.</p>

<p>Now we will include this module <strong>before <code>attr_accessor</code> calls</strong>. But beware: you need to declare an <code>@attributes</code> instance variable in the constructor!</p>

<p>And let&#39;s just agree with the following convention: <strong>all our attribute names should be symbols</strong>.</p>
<span class="k">class</span> <span class="nc">Posting</span>
  <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validations</span>
  <span class="kp">include</span> <span class="no">ActiveAttributes</span>

  <span class="nb">attr_accessor</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">:tags</span>

  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@attributes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">save</span>
    <span class="n">set_default_values</span>

    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">new</span><span class="p">(</span><span class="n">attributes</span><span class="p">).</span><span class="nf">save</span>
  <span class="k">end</span>

  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">set_default_values</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>

<p>Now, we can implement our constructor. We now have all the attributes&#39; getters and setter and thus we can simply call them in our constructor:</p>
<span class="k">class</span> <span class="nc">Posting</span>
  <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validations</span>
  <span class="kp">include</span> <span class="no">ActiveAttributes</span>

  <span class="nb">attr_accessor</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">:tags</span>

  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:body</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@attributes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">attributes</span><span class="p">.</span><span class="nf">symbolize_keys</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span>
      <span class="n">v</span><span class="p">.</span><span class="nf">symbolize_keys!</span> <span class="k">if</span> <span class="n">v</span><span class="p">.</span><span class="nf">is_a?</span> <span class="no">Hash</span>

      <span class="nb">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">="</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">="</span><span class="p">.</span><span class="nf">to_sym</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">save</span>
    <span class="n">set_default_values</span>

    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">new</span><span class="p">(</span><span class="n">attributes</span><span class="p">).</span><span class="nf">save</span>
  <span class="k">end</span>

  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">set_default_values</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>

<p>Now let&#39;s implement some basic model persisting. First, we should not forget about our <strong>validations</strong> and add <code>valid?</code> test to the <code>save</code> method.</p>

<p>Let&#39;s say our <code>save</code> method should return the model instance. Thus, we should put the model&#39; data into the database and get the <code>id</code> for that data (if we put the data with the <code>INSERT</code> statement).</p>

<p>So there is an important caveat: <strong>in order to get the correct model <code>id</code>, you need to get it from database in the same transaction as the update/insert statement</strong>. The <code>mysql2</code> gem does support multiple query statements in a single transaction. But to perform such a query, you will need to set the <code>MULTI_STATEMENTS</code> flag when creating a <code>Mysql2::Connection</code> instance.</p>
<span class="k">def</span> <span class="nf">save</span>
  <span class="n">set_default_values</span>

  <span class="k">return</span> <span class="nb">self</span> <span class="k">unless</span> <span class="n">valid?</span>

  <span class="vi">@connection</span> <span class="o">=</span> <span class="no">Mysql2</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">({</span> <span class="ss">flags: </span><span class="no">Mysql2</span><span class="o">::</span><span class="no">Client</span><span class="o">::</span><span class="no">MULTI_STATEMENTS</span> <span class="p">}.</span><span class="nf">merge</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>

  <span class="c1"># ...</span>

  <span class="nb">self</span>
<span class="k">rescue</span>
  <span class="nb">self</span>
<span class="k">ensure</span>
  <span class="vi">@connection</span><span class="p">.</span><span class="nf">close</span>
<span class="k">end</span>

<p>Here I used the instance variable <code>@connection</code> to make it available within the <code>rescue</code> and <code>ensure</code> statements.</p>

<p>Now we will use our instance variable, <code>@attributes</code> to create an SQL query:</p>
<span class="k">def</span> <span class="nf">save</span>
  <span class="n">set_default_values</span>

  <span class="k">return</span> <span class="nb">self</span> <span class="k">unless</span> <span class="n">valid?</span>

  <span class="vi">@connection</span> <span class="o">=</span> <span class="no">Mysql2</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">({</span> <span class="ss">flags: </span><span class="no">Mysql2</span><span class="o">::</span><span class="no">Client</span><span class="o">::</span><span class="no">MULTI_STATEMENTS</span> <span class="p">}.</span><span class="nf">merge</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>

    <span class="k">if</span> <span class="vi">@attributes</span><span class="p">[</span><span class="ss">:id</span><span class="p">].</span><span class="nf">blank?</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="vi">@attributes</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="s2">"`</span><span class="si">#{</span> <span class="n">k</span><span class="p">.</span><span class="nf">to_s</span> <span class="si">}</span><span class="s2">`"</span> <span class="p">}.</span><span class="nf">join</span> <span class="s1">','</span>
    <span class="n">values</span> <span class="o">=</span> <span class="vi">@attributes</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">v</span><span class="p">.</span><span class="nf">nil?</span>
        <span class="s1">'NULL'</span>
      <span class="k">else</span>
        <span class="s2">"'</span><span class="si">#{</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">helpers</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="nf">to_s</span><span class="p">)</span> <span class="si">}</span><span class="s2">'"</span>
      <span class="k">end</span>
    <span class="k">end</span><span class="p">.</span><span class="nf">join</span> <span class="s1">','</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">"INSERT INTO postings</span><span class="si">#{</span> <span class="n">volume</span> <span class="si">}</span><span class="s2"> (</span><span class="si">#{</span> <span class="n">columns</span> <span class="si">}</span><span class="s2">) VALUES (</span><span class="si">#{</span> <span class="n">values</span> <span class="si">}</span><span class="s2">)"</span>
  <span class="k">else</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="vi">@attributes</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="s2">"`</span><span class="si">#{</span> <span class="n">k</span><span class="p">.</span><span class="nf">to_s</span> <span class="si">}</span><span class="s2">` = </span><span class="si">#{</span> <span class="n">v</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="s1">'NULL'</span> <span class="p">:</span> <span class="s2">"'</span><span class="si">#{</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">helpers</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="si">}</span><span class="s2">'"</span> <span class="si">}</span><span class="s2">"</span> <span class="p">}.</span><span class="nf">join</span> <span class="s1">','</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">"UPDATE postings</span><span class="si">#{</span> <span class="n">volume</span> <span class="si">}</span><span class="s2"> SET </span><span class="si">#{</span> <span class="n">mapping</span> <span class="si">}</span><span class="s2"> WHERE id = </span><span class="si">#{</span> <span class="vi">@attributes</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span> <span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="nb">self</span>
<span class="k">rescue</span>
  <span class="nb">self</span>
<span class="k">ensure</span>
  <span class="vi">@connection</span><span class="p">.</span><span class="nf">close</span>
<span class="k">end</span>

<p>I used the <code>ActionController::Base.helpers.sanitize</code> helper method to escape the query parameters.</p>

<p>Now we should simply wrap our query into a transaction and get an <code>id</code> from the database.</p>
<span class="k">def</span> <span class="nf">save</span>
  <span class="n">set_default_values</span>

  <span class="k">return</span> <span class="nb">self</span> <span class="k">unless</span> <span class="n">valid?</span>

  <span class="vi">@connection</span> <span class="o">=</span> <span class="no">Mysql2</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">({</span> <span class="ss">flags: </span><span class="no">Mysql2</span><span class="o">::</span><span class="no">Client</span><span class="o">::</span><span class="no">MULTI_STATEMENTS</span> <span class="p">}.</span><span class="nf">merge</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>

  <span class="k">if</span> <span class="vi">@attributes</span><span class="p">[</span><span class="ss">:id</span><span class="p">].</span><span class="nf">blank?</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="vi">@attributes</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="s2">"`</span><span class="si">#{</span> <span class="n">k</span><span class="p">.</span><span class="nf">to_s</span> <span class="si">}</span><span class="s2">`"</span> <span class="p">}.</span><span class="nf">join</span> <span class="s1">','</span>
    <span class="n">values</span> <span class="o">=</span> <span class="vi">@attributes</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">v</span><span class="p">.</span><span class="nf">nil?</span>
        <span class="s1">'NULL'</span>
      <span class="k">else</span>
        <span class="s2">"'</span><span class="si">#{</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">helpers</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="nf">to_s</span><span class="p">)</span> <span class="si">}</span><span class="s2">'"</span>
      <span class="k">end</span>
    <span class="k">end</span><span class="p">.</span><span class="nf">join</span> <span class="s1">','</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">"INSERT INTO postings</span><span class="si">#{</span> <span class="n">volume</span> <span class="si">}</span><span class="s2"> (</span><span class="si">#{</span> <span class="n">columns</span> <span class="si">}</span><span class="s2">) VALUES (</span><span class="si">#{</span> <span class="n">values</span> <span class="si">}</span><span class="s2">)"</span>
  <span class="k">else</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="vi">@attributes</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="s2">"`</span><span class="si">#{</span> <span class="n">k</span><span class="p">.</span><span class="nf">to_s</span> <span class="si">}</span><span class="s2">` = </span><span class="si">#{</span> <span class="n">v</span><span class="p">.</span><span class="nf">nil?</span> <span class="p">?</span> <span class="s1">'NULL'</span> <span class="p">:</span> <span class="s2">"'</span><span class="si">#{</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">helpers</span><span class="p">.</span><span class="nf">sanitize</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="si">}</span><span class="s2">'"</span> <span class="si">}</span><span class="s2">"</span> <span class="p">}.</span><span class="nf">join</span> <span class="s1">','</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s2">"UPDATE postings</span><span class="si">#{</span> <span class="n">volume</span> <span class="si">}</span><span class="s2"> SET </span><span class="si">#{</span> <span class="n">mapping</span> <span class="si">}</span><span class="s2"> WHERE id = </span><span class="si">#{</span> <span class="vi">@attributes</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span> <span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="n">query</span> <span class="o">=</span> <span class="s2">"START TRANSACTION; </span><span class="si">#{</span> <span class="n">query</span> <span class="si">}</span><span class="s2">; SELECT LAST_INSERT_ID() AS id; COMMIT;"</span>

  <span class="vi">@connection</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

  <span class="k">while</span> <span class="vi">@connection</span><span class="p">.</span><span class="nf">next_result</span>
    <span class="n">result</span> <span class="o">=</span> <span class="vi">@connection</span><span class="p">.</span><span class="nf">store_result</span><span class="p">.</span><span class="nf">to_a</span> <span class="k">rescue</span> <span class="kp">nil</span>

    <span class="vi">@attributes</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="nf">first</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="nf">present?</span> <span class="n">and</span> <span class="n">result</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">present?</span> <span class="n">and</span> <span class="n">result</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">has_key?</span> <span class="s1">'id'</span>
  <span class="k">end</span>

  <span class="nb">self</span>
<span class="k">rescue</span>
  <span class="nb">self</span>
<span class="k">ensure</span>
  <span class="vi">@connection</span><span class="p">.</span><span class="nf">close</span>
<span class="k">end</span>

<p>Quite big method, sure. Yet, it performs all the <em>UPDATEs</em> and <em>INSERTs</em> for us.</p>

<p>Let&#39;s add some attribute with the default value, <code>created_at</code> and check how the whole class works:</p>
<span class="nb">require</span> <span class="s1">'date'</span>

<span class="c1"># ...</span>

<span class="nb">attr_accessor</span> <span class="ss">:created_at</span>

<span class="c1"># ...</span>

<span class="kp">protected</span>

<span class="k">def</span> <span class="nf">set_default_values</span>
  <span class="vi">@attributes</span><span class="p">[</span><span class="ss">:created_at</span><span class="p">]</span> <span class="o">=</span> <span class="no">DateTime</span><span class="p">.</span><span class="nf">now</span>
<span class="k">end</span>

<p>And the test:</p>
<span class="nb">p</span> <span class="o">=</span> <span class="no">Posting</span><span class="p">.</span><span class="nf">new</span> <span class="ss">title: </span><span class="s2">"Hello, ActiveModel!"</span><span class="p">,</span> <span class="ss">body: </span><span class="s2">"Hello, Database!"</span>

<span class="nb">p</span><span class="p">.</span><span class="nf">save</span>

<span class="nb">puts</span> <span class="nb">p</span><span class="p">.</span><span class="nf">created_at</span>
