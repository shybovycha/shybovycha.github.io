<meta name="layout" content="post">
<meta name="title" content="Чоткій блог на PHP. Часть перша">
<meta name="date" content="2014-07-22T12:45:00+02:00">
<meta name="tags" content="programming,php,rtfm">
<meta name="tumblr_url" content="http://shybovycha.tumblr.com/post/92523360106/php">
<div class="row">
    <div class="col-md-6 col-xs-12">
        Liquid error: internal
    </div>

    <div class="col-md-6 col-xs-12 text-xs-center text-md-right"></div>
</div>

<h2>Прєдісловіє</h2>

<p>Дарагой друг! В цих статтях я розкажу тобі як зробить чоткій блог на чотком язику PHP. Розказувать буду просто, шоб всьо було понятно. Ну шо, паєхалі?</p>

<h2>Сістємні трєбованія</h2>

<p>Нехай у нас є який-небудь самий стандартний, простий, перший блог на PHP. Така собі кучка файлів для созданія постов, списка постов, перегляду оддєльного поста, реєстрації, логіна і логаута, камєнтіруванія... Просто купа файлів. В цих файлах у нас і HTML, і PHP код.</p>

<!--more-->

<p>Приблизно це виглядить отак:</p>

<p><img alt="нечотка файлова структура" src="https://31.media.tumblr.com/0a8d7d23deb6bbb91b684da390b15a48/tumblr_inline_n94vrsNmqi1qh5oee.png"/>.</p>

<p>І дуже-дуже нада знать CSS, HTML, ООП в PHP і потом, може, JavaScript і jQuery.</p>

<p>Перед началом роботи краще привести в порядок HTML і CSS - розбити всьо красіво по папочкам (CSS - оддєльно, рісунки - оддєльно, PHP-файли - оддєльно); убрать з HTML всі атрібути <code>style=&quot;...&quot;</code>, всюди пороздававши класи елементам; пообертать атрібути в кавички (<code>height=&quot;15px&quot;</code>, а не <code>height=15px</code>) і так далєє. Шоб ще прощє було потом читать код.</p>

<h2>Чистим HTML код</h2>

<p>Першим ділом ми будем умєньшать кількість кода, шо є в нашом блогє. В народі це називається <strong>принцип DRY, Don’t Repeat Yourself</strong>. Розшифровується воно як <strong>пацани дважди не повторяють</strong>. В RubyOnRails і других крутих штуках шось подобне реалізовано так, шоб весь HTML-код і PHP-код (ну або там Ruby-код, Python-код, будь-який-язик-программіруванія-код) були оддєльно, ну або хотя би по мінімуму PHP і по максімуму HTML.</p>

<p>Тоість, єсть такі штуки, які називаються <code>View</code> і єсть такі штуки які називаються <code>Controller</code>. Так от, в View - у нас чисто виводиться інформація, форматірується з помощю HTML, а чучуть кода все ще є для всяких циклов, іфов або визовов методов <code>Helper</code>-ов (якшо нада хітро вивести шось - ссилку, напрімєр, на пост або на удалєніє поста - шоб самому не писати весь адрєс ссилки - можна воспользоватись допоміжним мєтодом; од того і Helper). А в Controller - весь PHP код, який получає дані з бази даних, методи-Helpers, і вобщє нема HTML кода.</p>

<p>Виглядить це якось отако: якшо у нас було</p>

<p><img alt="нечоткий код index.php" src="https://31.media.tumblr.com/5f1a4a1124dc4f99dc91c0ccb1f44915/tumblr_inline_n94vt1XEHH1qh5oee.png"/></p>

<p>то має стати</p>

<p><img alt="чоткий код index.php" src="https://31.media.tumblr.com/3745645e9005922b5bae3d5bfb4f29c0/tumblr_inline_n94vtd8sEq1qh5oee.png"/></p>

<p>Так шо першим ділом ми будем убирать з нашого HTML весь лишній PHP код. Да, і желатєльно заранєє договоритись шо до цього момєнта HTML має бути подчищений от лишнього CSS - як мінімум всі <code>style=&quot;css-code&quot;</code> замінить на <code>class=&quot;class-name&quot;</code>. Шоб простіше було орієнтіруватись в коді.</p>

<h2>Перший кантроллєр</h2>

<p>Давай попробуєм зробить сначала контроллєр для странічки <code>index.php</code>, в якій отображаються всі пости. По старой, доброй традіції, ми зробим оддєльний файл з классом і подключим його зверху <code>index.php</code> через <code>require_once()</code>.</p>

<p>Якшо ти помниш ООП, то у классов є такій магічний мєтод як конструктор. Так вот, в ньому ми будем робити круту таку штуку як загрузку даних (із бази, із сесії, із куков) в пєрємєнні, які потом будем іспользовать.</p>

<p>Напрімєр, якшо ми перероблюємо список постінгов, то нам нада масив всіх наших постів з бази взять. Якшо нам там же треба пользоватєль, який залогінений - нам із сесії треба його взять. Або рішить, шо його нема.</p>

<p>Виглядить це буде отако:</p>
<span class="k">require</span><span class="p">(</span><span class="s1">'connect.php'</span><span class="p">);</span>

<span class="kd">class</span> <span class="nc">PostingsController</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">$postings</span><span class="p">,</span> <span class="nv">$user</span><span class="p">;</span>

    <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// получаєм з бази пости</span>
        <span class="nv">$res</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="s2">"SELECT * FROM postings"</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">postings</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

        <span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$res</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">postings</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// берем із сесії пользоватєля</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">user</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">user</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<p>Давай зразу робить чотку структуру файлов. Зробим папку <code>controllers</code> і туди будем сохранять контроллєри в файлах <code>***_controller.php</code>. Тоість, наш оцей клас ми положим в файл <code>controllers/PostingsController.php</code>.</p>

<p>Тепер в файлі <code>index.php</code> в самом верху, де у нас раньше подключалась база даних і прочі штуки, у нас буде тільки <code>require()</code> цього контроллєра. Но поки у нас архітєктура не дуже крута, то ще одну строчку прийдеться добавить:</p>
<span class="k">require_once</span><span class="p">(</span><span class="s1">'controllers/PostingsController.php'</span><span class="p">);</span>

<span class="nv">$controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PostingsController</span><span class="p">();</span>

<p>І тепер всі оці <code>while ($posting = mysql_fetch_assoc($res)) { ... }</code> можна замінить на <code>foreach ($controller-&gt;postings as $posting) { ... }</code>, а <code>$_SESSION[&#39;user&#39;]</code> - на <code>$controller-&gt;user</code>. І це кручє, бо ми можем юзера і в базі тримать, і ще невідомо де. Ну а постінги - так вроді прощє іспользувать.</p>

<h1>Перший хелпєр</h1>

<p>А тепер давай ще додамо перший метод, який упростить жизнь і покаже мощь архітєктури. Він нам помогатиме формірувать URL до постінга. Це шось тіпа:</p>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"view.php?id=</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$posting</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="cp">?&gt;</span><span class="s">"</span><span class="nt">&gt;</span>...<span class="nt">&lt;/a&gt;</span>

<p>буде замінений на</p>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$controller</span><span class="o">-&gt;</span><span class="na">viewPostingUrl</span><span class="p">(</span><span class="nv">$posting</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">"</span><span class="nt">&gt;</span>...<span class="nt">&lt;/a&gt;</span>

<p>Согласись, якшо внезапно поміняється путь до файла, який буде отвічать за просмотр поста, то в першому случаї прийдеться багато де мінять цю строчку, а в другому случаї - тільки в кантроллєрі.</p>

<p>Отак, у нас цей метод буде принімать масів і вертать строчку… Зробим його пока шо простим:</p>
<span class="k">public</span> <span class="k">function</span> <span class="nf">viewPostingUrl</span><span class="p">(</span><span class="nv">$posting</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$posting</span><span class="p">[</span><span class="s1">'id'</span><span class="p">];</span>
    <span class="k">return</span> <span class="s2">"view.php?id=</span><span class="nv">$id</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>

<h2>Домашнєє заданіє</h2>

<p>Попробуй зробити всякі другі хелпери - для ссилок на удалєніє постов, на редактіруваніє, і прочі.</p>
