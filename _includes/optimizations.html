<script async>
  window.addEventListener('load', () => {
    const lazyLoadImage = (imgElt) => {
      const src = imgElt.getAttribute('data-src');
      const img = new Image();

      img.onload = () => {
        if (!!imgElt.parent) {
          imgElt.parent.replaceChild(img, imgElt);
        } else {
          imgElt.src = src;
        }
      };

      img.src = src;
    };

    const elementInViewport = (elt) => {
      const rect = elt.getBoundingClientRect();

      return (rect.top >= 0 && rect.left >= 0 && rect.top <= (window.innerHeight * 3 || document.documentElement.clientHeight * 3));
    };

    // defer loading images
    const images = Array.from(document.querySelectorAll('img[data-src]'));
    let visibleImages = images.filter(img => elementInViewport(img));
    let invisibleImages = images.filter(img => !elementInViewport(img));

    // immediately load visible images
    setTimeout(() => visibleImages.forEach(lazyLoadImage), 0);

    // defer invisible images to be lazy-loaded
    window.addEventListener('scroll', () => {
      invisibleImages = invisibleImages.filter((imgElt) => {
        if (elementInViewport(imgElt)) {
          lazyLoadImage(imgElt);
          return false;
        } else {
          return true;
        }
      });
    });

    // defer main.css
    const head = document.querySelector('head');
    const styles = [ '/css/main.css' ];

    styles.forEach((src) => {
      const elt = document.createElement('link');

      elt.rel = 'stylesheet';
      elt.href = src;

      head.appendChild(elt);
    });

    setTimeout(() => {
      // load heavy body background
      let bgSrc = '/images/background2-compressed.jpg';

      if (navigator.userAgent.indexOf('Chrome') !== -1 || navigator.userAgent.indexOf('Firefox') !== -1) {
        bgSrc = '/images/background2-compressed.webp';
      }

      document.body.style['background'] = 'url(' + bgSrc + ') no-repeat top left fixed';
    }, 0);
  });
</script>